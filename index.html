<!DOCTYPE html>
<html lang="en-AU">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Family Hub">
  <meta name="theme-color" content="#2563eb">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="logo.png">
  <title>Family Hub</title>
  <link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@300;400;600;700&family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --primary: #2563eb; --primary-dark: #1e40af; --secondary: #0891b2;
      --accent: #f59e0b; --text-dark: #1f2937; --text-medium: #4b5563;
      --text-light: #6b7280; --bg-white: #ffffff; --bg-light: #f9fafb;
      --bg-lighter: #f3f4f6; --border: #e5e7eb; --border-light: #f3f4f6;
      --font-heading: 'Merriweather', serif; --font-body: 'Source Sans 3', sans-serif;
    }
    body { font-family: var(--font-body); background: var(--bg-white); color: var(--text-dark); line-height: 1.6; }
    .app-container { max-width: 1200px; margin: 0 auto; padding: 0 1.5rem 100px; }
    
    .header { background: rgba(255, 255, 255, 0.95); border-bottom: 1px solid var(--border); padding: 1.25rem 0; margin-bottom: 3rem; position: sticky; top: 0; z-index: 50; backdrop-filter: blur(8px); box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    .header-content { max-width: 1200px; margin: 0 auto; padding: 0 1.5rem; display: flex; justify-content: center; align-items: center; }
    .logo-container { display: flex; align-items: center; justify-content: center; }
    .logo-image { height: 220px; width: auto; cursor: pointer; transition: transform 0.2s ease; }
    .logo-image:hover { transform: scale(1.02); }
    
    .quick-nav { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem; margin-bottom: 2.5rem; }
    .quick-nav-item { background: var(--bg-white); border: 1px solid var(--border); border-radius: 8px; padding: 1.5rem 1rem; text-align: center; cursor: pointer; transition: all 0.2s ease; }
    .quick-nav-item:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.1); border-color: var(--primary); }
    .quick-nav-icon { width: 32px; height: 32px; stroke: var(--primary); margin: 0 auto 0.75rem; }
    .quick-nav-label { font-weight: 600; font-size: 0.9rem; }
    
    .page { display: none; }
    .page.active { display: block; animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .page-header { margin-bottom: 2.5rem; padding-bottom: 1.5rem; border-bottom: 2px solid var(--border-light); }
    .page-title { font-family: var(--font-heading); font-size: 2.25rem; font-weight: 700; color: var(--text-dark); margin-bottom: 0.5rem; }
    .page-subtitle { color: var(--text-medium); font-size: 1.1rem; }
    
    .card { background: var(--bg-white); border: 1px solid var(--border); border-radius: 8px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); }
    .card:hover { box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-light); }
    .card-title { font-family: var(--font-heading); font-size: 1.5rem; font-weight: 700; }
    
    .countdown-calendar-section { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2.5rem; }
    .countdown-cards { display: flex; flex-direction: column; gap: 1rem; }
    
    .countdown-card { background: linear-gradient(135deg, var(--primary), var(--secondary)); border-radius: 8px; padding: 0; overflow: hidden; border: 1px solid var(--border); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
    .countdown-image { width: 100%; height: 180px; background-size: cover; background-position: center; position: relative; }
    .countdown-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(to bottom, transparent, rgba(37, 99, 235, 0.8)); display: flex; align-items: flex-end; padding: 1.5rem; }
    .countdown-destination { color: white; font-size: 1.5rem; font-weight: 700; font-family: var(--font-heading); }
    .countdown-body { padding: 2rem; text-align: center; color: white; }
    .countdown-title { font-size: 0.95rem; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 1rem; opacity: 0.9; }
    .countdown-value { font-size: 3.5rem; font-weight: 700; font-family: var(--font-heading); margin-bottom: 0.5rem; }
    .countdown-label { font-size: 1rem; opacity: 0.9; }
    
    .mini-calendar-card { background: var(--bg-white); border: 1px solid var(--border); border-radius: 8px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); }
    .mini-calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.25rem; }
    .mini-calendar-title { font-family: var(--font-heading); font-size: 1.25rem; font-weight: 700; }
    .mini-calendar-nav { display: flex; gap: 0.5rem; }
    .mini-calendar-btn { background: none; border: 1px solid var(--border); padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; color: var(--text-medium); transition: all 0.2s ease; }
    .mini-calendar-btn:hover { background: var(--bg-light); border-color: var(--primary); color: var(--primary); }
    .mini-calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.35rem; }
    .mini-calendar-day-header { text-align: center; padding: 0.5rem 0.25rem; font-weight: 600; font-size: 0.75rem; color: var(--text-medium); }
    .mini-calendar-day { aspect-ratio: 1; background: var(--bg-light); border: 1px solid var(--border-light); border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 0.85rem; cursor: pointer; transition: all 0.2s ease; font-weight: 500; position: relative; }
    .mini-calendar-day:hover { background: var(--bg-lighter); border-color: var(--primary); }
    .mini-calendar-day.today { background: var(--primary); color: white; font-weight: 700; border-color: var(--primary); }
    .mini-calendar-day.has-event::after { content: '‚Ä¢'; position: absolute; bottom: 2px; color: var(--accent); font-size: 1.2rem; }
    
    .upcoming-event { background: var(--bg-light); border-left: 4px solid var(--primary); padding: 0.75rem; margin-bottom: 0.5rem; border-radius: 4px; cursor: pointer; }
    .upcoming-event:hover { background: var(--bg-lighter); }
    .upcoming-event.sport { border-left-color: #10b981; }
    .upcoming-event.school { border-left-color: #8b5cf6; }
    .upcoming-event.health { border-left-color: #ef4444; }
    .upcoming-event.travel { border-left-color: #f59e0b; }
    .upcoming-event.family { border-left-color: #2563eb; }
    .event-date { font-size: 0.75rem; font-weight: 700; color: var(--text-medium); text-transform: uppercase; }
    .event-time { font-size: 0.8rem; color: var(--primary); font-weight: 600; margin-top: 0.25rem; }
    .event-title { font-weight: 600; margin-top: 0.25rem; }
    
    
    .map-card { background: var(--bg-white); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); margin-bottom: 2rem; }
    .map-header { padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--border-light); background: var(--bg-light); }
    .map-header h3 { font-family: var(--font-heading); font-size: 1.25rem; font-weight: 700; margin-bottom: 0.5rem; }
    .map-header p { font-size: 0.9rem; color: var(--text-medium); }
    #worldMap { height: 450px; width: 100%; }
    
    .photo-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem; }
    .photo-item { aspect-ratio: 1; border-radius: 6px; background: var(--bg-light); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; color: var(--text-light); font-size: 2rem; cursor: pointer; transition: all 0.2s ease; }
    .photo-item:hover { transform: scale(1.02); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
    
    /* Enhanced Calendar with Event Titles */
    .calendar-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-light); flex-wrap: wrap; gap: 1rem; }
    .calendar-month { font-family: var(--font-heading); font-size: 1.5rem; font-weight: 700; }
    .calendar-actions { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.5rem; }
    .calendar-day-header { text-align: center; padding: 0.75rem 0.5rem; font-weight: 600; font-size: 0.85rem; color: var(--text-medium); text-transform: uppercase; background: var(--bg-light); border-radius: 4px; }
    .calendar-day { min-height: 120px; background: var(--bg-light); border: 1px solid var(--border-light); border-radius: 6px; padding: 0.5rem; cursor: pointer; transition: all 0.2s ease; display: flex; flex-direction: column; }
    .calendar-day:hover { background: var(--bg-lighter); border-color: var(--primary); transform: translateY(-2px); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .calendar-day.today { border: 2px solid var(--primary); background: rgba(37, 99, 235, 0.05); }
    .calendar-day.has-event { border-left: 4px solid var(--accent); }
    .calendar-day-number { font-weight: 700; font-size: 0.95rem; margin-bottom: 0.5rem; color: var(--text-dark); }
    .calendar-day.today .calendar-day-number { color: var(--primary); }
    .calendar-events { display: flex; flex-direction: column; gap: 0.25rem; overflow-y: auto; flex: 1; }
    .calendar-event { background: white; border: 1px solid var(--border); border-radius: 4px; padding: 0.35rem 0.5rem; font-size: 0.75rem; font-weight: 600; color: var(--text-dark); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; transition: all 0.2s ease; }
    .calendar-event:hover { background: var(--primary); color: white; transform: translateX(2px); }
    .calendar-event.sport { border-left: 3px solid #10b981; }
    .calendar-event.school { border-left: 3px solid #8b5cf6; }
    .calendar-event.health { border-left: 3px solid #ef4444; }
    .calendar-event.travel { border-left: 3px solid #f59e0b; }
    .calendar-event.recurring { font-style: italic; }
    .calendar-event-time { color: var(--text-medium); font-size: 0.7rem; font-weight: 500; }
    
    .event-list { display: flex; flex-direction: column; gap: 1rem; margin-top: 2rem; }
    .event-item { background: var(--bg-light); border: 1px solid var(--border); border-radius: 6px; padding: 1.25rem; transition: all 0.2s ease; cursor: pointer; }
    .event-item:hover { background: var(--bg-lighter); border-color: var(--primary); }
    .event-item-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem; }
    .event-item-title { font-weight: 700; font-size: 1.1rem; color: var(--text-dark); }
    .event-item-time { font-size: 0.9rem; color: var(--text-medium); font-weight: 600; }
    .event-item-details { color: var(--text-medium); font-size: 0.95rem; margin-bottom: 0.75rem; }
    .event-item-meta { display: flex; gap: 1rem; flex-wrap: wrap; }
    .event-badge { display: inline-flex; align-items: center; gap: 0.35rem; padding: 0.25rem 0.75rem; background: var(--bg-white); border: 1px solid var(--border); border-radius: 12px; font-size: 0.8rem; color: var(--text-medium); }
    .event-badge.recurring { background: var(--primary); color: white; border-color: var(--primary); }
    .event-attachments { display: flex; gap: 0.5rem; margin-top: 0.75rem; flex-wrap: wrap; }
    .event-attachment { display: inline-flex; align-items: center; gap: 0.35rem; padding: 0.35rem 0.75rem; background: white; border: 1px solid var(--border); border-radius: 4px; font-size: 0.85rem; text-decoration: none; color: var(--primary); transition: all 0.2s ease; }
    .event-attachment:hover { background: var(--bg-light); border-color: var(--primary); }
    .attachment-icon { width: 14px; height: 14px; }
    
    /* Sync Status */
    .sync-status { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: var(--bg-light); border: 1px solid var(--border); border-radius: 6px; font-size: 0.85rem; }
    .sync-status.synced { border-color: #10b981; background: rgba(16, 185, 129, 0.1); color: #10b981; }
    .sync-icon { width: 16px; height: 16px; }
    
    .timeline { position: relative; padding-left: 2.5rem; }
    .timeline::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 2px; background: var(--border); }
    .timeline-item { position: relative; margin-bottom: 2rem; }
    .timeline-item::before { content: ''; position: absolute; left: -2.5rem; top: 0.25rem; width: 14px; height: 14px; background: var(--primary); border-radius: 50%; border: 3px solid var(--bg-white); box-shadow: 0 0 0 2px var(--primary); }
    .timeline-date { font-size: 0.9rem; color: var(--primary); font-weight: 700; margin-bottom: 0.5rem; text-transform: uppercase; }
    .timeline-content { background: var(--bg-light); padding: 1.25rem; border-radius: 6px; border: 1px solid var(--border-light); }
    .timeline-title { font-weight: 700; margin-bottom: 0.5rem; }
    .timeline-text { color: var(--text-medium); font-size: 0.95rem; }
    .timeline-source { display: inline-block; margin-top: 0.5rem; padding: 0.25rem 0.75rem; background: var(--bg-white); border: 1px solid var(--border); border-radius: 4px; font-size: 0.8rem; color: var(--text-medium); }
    
    .trips-layout { display: grid; grid-template-columns: 300px 1fr; gap: 2rem; min-height: 600px; }
    .trips-sidebar { border-right: 1px solid var(--border); padding-right: 2rem; }
    .trip-list { display: flex; flex-direction: column; gap: 0.75rem; }
    .trip-item { padding: 1rem; border: 1px solid var(--border); border-radius: 6px; cursor: pointer; background: var(--bg-white); transition: all 0.2s ease; }
    .trip-item:hover { background: var(--bg-light); border-color: var(--primary); }
    .trip-item.active { background: var(--primary); color: white; }
    .trip-item-name { font-weight: 600; margin-bottom: 0.25rem; }
    .trip-item-dates { font-size: 0.85rem; color: var(--text-medium); }
    .trip-item.active .trip-item-name, .trip-item.active .trip-item-dates { color: white; }
    .trip-detail { background: var(--bg-light); border-radius: 8px; padding: 2rem; }
    .trip-header { margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 2px solid var(--border); }
    .trip-title { font-family: var(--font-heading); font-size: 2rem; margin-bottom: 0.5rem; }
    .trip-meta { display: flex; gap: 2rem; color: var(--text-medium); flex-wrap: wrap; }
    .trip-tabs { display: flex; gap: 0.5rem; margin-bottom: 2rem; border-bottom: 2px solid var(--border-light); }
    .trip-tab { padding: 0.75rem 1.5rem; background: none; border: none; border-bottom: 2px solid transparent; margin-bottom: -2px; color: var(--text-medium); cursor: pointer; font-family: var(--font-body); font-weight: 600; transition: all 0.2s ease; }
    .trip-tab:hover { color: var(--primary); }
    .trip-tab.active { color: var(--primary); border-bottom-color: var(--primary); }
    .trip-tab-content { display: none; }
    .trip-tab-content.active { display: block; }
    .itinerary-day { background: white; border: 1px solid var(--border); border-radius: 6px; padding: 1.25rem; margin-bottom: 1rem; }
    .itinerary-day-header { display: flex; justify-content: space-between; margin-bottom: 1rem; }
    .itinerary-day-title { font-weight: 700; }
    .itinerary-activities { display: flex; flex-direction: column; gap: 0.75rem; }
    .activity-item { display: flex; gap: 1rem; padding: 0.75rem; background: var(--bg-light); border-radius: 4px; }
    .activity-time { font-weight: 600; color: var(--primary); min-width: 70px; font-size: 0.85rem; }
    .activity-name { font-weight: 600; margin-bottom: 0.25rem; }
    .activity-description { font-size: 0.9rem; color: var(--text-medium); }
    .documents-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; }
    .document-item { background: white; border: 1px solid var(--border); border-radius: 6px; padding: 1rem; text-align: center; cursor: pointer; transition: all 0.2s ease; }
    .document-item:hover { border-color: var(--primary); background: var(--bg-light); }
    .document-icon { width: 48px; height: 48px; margin: 0 auto 0.75rem; stroke: var(--primary); }
    .document-name { font-weight: 600; font-size: 0.9rem; margin-bottom: 0.25rem; }
    .document-size { font-size: 0.8rem; color: var(--text-medium); }
    
    .sport-entries { display: grid; gap: 1.5rem; }
    .sport-entry { background: var(--bg-white); border: 1px solid var(--border); border-radius: 8px; padding: 1.5rem; }
    .sport-entry-header { display: grid; grid-template-columns: 1fr auto; gap: 1rem; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-light); }
    .sport-entry-title { font-weight: 700; font-size: 1.2rem; }
    .sport-entry-athlete { color: var(--primary); font-weight: 600; }
    .sport-badge { background: var(--primary); color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem; font-weight: 600; }
    .sport-entry-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem; }
    .sport-detail { display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; }
    .sport-detail-icon { width: 16px; height: 16px; stroke: var(--text-medium); }
    .sport-result { background: var(--bg-light); padding: 1rem; border-radius: 6px; margin-top: 1rem; }
    .sport-result-label { font-weight: 600; margin-bottom: 0.5rem; }
    .sport-links { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 1rem; }
    .sport-link { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: white; border: 1px solid var(--border); border-radius: 6px; text-decoration: none; color: var(--primary); font-size: 0.85rem; font-weight: 600; }
    .sport-link:hover { background: var(--bg-light); border-color: var(--primary); }
    
    .task-tabs { display: flex; gap: 0.5rem; margin-bottom: 2rem; border-bottom: 2px solid var(--border-light); }
    .task-tab { padding: 0.75rem 1.5rem; background: none; border: none; border-bottom: 2px solid transparent; margin-bottom: -2px; color: var(--text-medium); cursor: pointer; font-family: var(--font-body); font-weight: 600; transition: all 0.2s ease; }
    .task-tab:hover { color: var(--primary); }
    .task-tab.active { color: var(--primary); border-bottom-color: var(--primary); }
    .task-content { display: none; }
    .task-content.active { display: block; }
    .task-list { display: flex; flex-direction: column; gap: 0.75rem; }
    .task-item { display: flex; align-items: center; gap: 1rem; padding: 1rem 1.25rem; background: var(--bg-light); border: 1px solid var(--border-light); border-radius: 6px; cursor: pointer; }
    .task-checkbox { width: 20px; height: 20px; border: 2px solid var(--primary); border-radius: 4px; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.75rem; }
    .task-item.completed .task-checkbox { background: var(--primary); }
    .task-item.completed .task-text { text-decoration: line-through; opacity: 0.6; }
    .task-text { font-weight: 500; }
    
    /* Health with Attachments */
    .health-grid { display: grid; gap: 1rem; }
    .health-record { background: var(--bg-light); padding: 1.25rem; border-radius: 6px; border-left: 4px solid var(--primary); transition: all 0.2s ease; cursor: pointer; }
    .health-record:hover { background: var(--bg-lighter); transform: translateX(4px); }
    .health-header { display: flex; justify-content: space-between; margin-bottom: 0.75rem; }
    .health-name { font-weight: 700; font-size: 1.05rem; }
    .health-date { font-size: 0.85rem; color: var(--text-medium); font-weight: 600; }
    .health-detail { color: var(--text-medium); margin-bottom: 0.75rem; }
    .health-attachments { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--border-light); }
    
    .link-list { display: flex; flex-direction: column; gap: 0.75rem; }
    .link-item { display: flex; align-items: center; gap: 1rem; padding: 1.25rem 1.5rem; background: var(--bg-light); border: 1px solid var(--border); border-radius: 6px; text-decoration: none; color: var(--text-dark); font-weight: 600; transition: all 0.2s ease; }
    .link-item:hover { background: var(--bg-lighter); border-color: var(--primary); color: var(--primary); transform: translateX(4px); }
    .link-icon { width: 20px; height: 20px; stroke: var(--primary); }
    
    .btn { background: var(--primary); color: white; border: none; padding: 0.75rem 1.75rem; border-radius: 6px; font-weight: 600; cursor: pointer; font-family: var(--font-body); font-size: 1rem; transition: all 0.2s ease; }
    .btn:hover { background: var(--primary-dark); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2); }
    .btn-secondary { background: white; color: var(--primary); border: 1px solid var(--border); }
    .btn-secondary:hover { background: var(--bg-light); }
    .btn-small { padding: 0.5rem 1rem; font-size: 0.9rem; }
    .btn-icon { display: inline-flex; align-items: center; gap: 0.5rem; }
    
    .form-group { margin-bottom: 1.5rem; }
    .form-label { display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.95rem; }
    .form-input, .form-textarea, .form-select { width: 100%; background: white; border: 1px solid var(--border); border-radius: 6px; padding: 0.75rem 1rem; font-family: var(--font-body); font-size: 1rem; }
    .form-input:focus, .form-textarea:focus, .form-select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
    .form-textarea { resize: vertical; min-height: 100px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .form-checkbox-group { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-light); border-radius: 6px; margin-bottom: 1rem; }
    .form-checkbox { width: 20px; height: 20px; cursor: pointer; }
    
    .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center; padding: 1rem; }
    .modal.active { display: flex; }
    .modal-content { background: white; border-radius: 8px; padding: 2rem; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-light); }
    .modal-title { font-family: var(--font-heading); font-size: 1.5rem; font-weight: 700; }
    .close-modal { background: none; border: none; color: var(--text-light); cursor: pointer; font-size: 1.5rem; padding: 0; }
    
    .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid var(--border); padding: 0.75rem 0; z-index: 100; box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05); }
    .nav-container { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-around; padding: 0 1rem; }
    .nav-item { display: flex; flex-direction: column; align-items: center; gap: 0.25rem; cursor: pointer; padding: 0.5rem 0.75rem; border-radius: 6px; color: var(--text-medium); font-size: 0.75rem; font-weight: 600; min-width: 70px; transition: all 0.2s ease; }
    .nav-item:hover { color: var(--primary); background: var(--bg-light); }
    .nav-item.active { color: var(--primary); background: var(--bg-lighter); }
    .nav-icon { width: 24px; height: 24px; stroke: currentColor; stroke-width: 2; fill: none; }
    
    .leaflet-popup-content-wrapper { border-radius: 8px; }
    .leaflet-popup-content { margin: 1rem; font-family: var(--font-body); }
    .popup-title { font-weight: 700; margin-bottom: 0.5rem; }
    
    .info-box { background: rgba(37, 99, 235, 0.1); border: 1px solid var(--primary); border-radius: 6px; padding: 1rem; margin-bottom: 1.5rem; }
    .info-box-title { font-weight: 700; color: var(--primary); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; }
    .info-box-text { font-size: 0.9rem; color: var(--text-medium); }
    
    .photo-card { border-radius: 6px; background: var(--bg-light); border: 1px solid var(--border); overflow: hidden; cursor: pointer; transition: all 0.2s ease; }
    .photo-card:hover { transform: scale(1.02); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
    .photo-placeholder { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-size: 2rem; background: var(--bg-lighter); }
    .photo-info { padding: 0.75rem; font-weight: 600; font-size: 0.9rem; }

    .memory-timeline { position: relative; padding-left: 2.5rem; }
    .memory-timeline::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 2px; background: var(--border); }
    .memory-item { position: relative; margin-bottom: 2rem; }
    .memory-item::before { content: ''; position: absolute; left: -2.5rem; top: 0.25rem; width: 14px; height: 14px; background: var(--primary); border-radius: 50%; border: 3px solid var(--bg-white); box-shadow: 0 0 0 2px var(--primary); }
    .memory-date { font-size: 0.9rem; color: var(--primary); font-weight: 700; margin-bottom: 0.5rem; text-transform: uppercase; }
    .memory-content { background: var(--bg-light); padding: 1.25rem; border-radius: 6px; border: 1px solid var(--border-light); }
    .memory-title { font-weight: 700; margin-bottom: 0.5rem; font-size: 1.1rem; }
    .memory-text { color: var(--text-medium); font-size: 0.95rem; line-height: 1.6; }
    .memory-photos { display: flex; gap: 0.5rem; margin-top: 1rem; flex-wrap: wrap; }
    .memory-photo { width: 60px; height: 60px; background: var(--bg-lighter); border: 1px solid var(--border); border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; }

    /* Login Screen */
    .login-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--bg-white); z-index: 2000; display: flex; align-items: center; justify-content: center; }
    .login-overlay.hidden { display: none; }
    .login-card { text-align: center; padding: 3rem 2rem; max-width: 400px; width: 100%; }
    .login-card .logo-image { height: 160px; margin-bottom: 2rem; }
    .login-title { font-family: var(--font-heading); font-size: 1.5rem; font-weight: 700; color: var(--text-dark); margin-bottom: 0.5rem; }
    .login-subtitle { color: var(--text-medium); font-size: 0.95rem; margin-bottom: 2rem; }
    .pin-input { width: 200px; text-align: center; font-size: 2rem; letter-spacing: 0.75rem; padding: 0.75rem 1rem; border: 2px solid var(--border); border-radius: 8px; font-family: var(--font-body); outline: none; transition: border-color 0.2s; }
    .pin-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
    .login-btn { margin-top: 1.5rem; width: 200px; }
    .login-error { color: #ef4444; font-size: 0.85rem; margin-top: 0.75rem; min-height: 1.25rem; }

    /* Delete & Danger Buttons */
    .btn-danger { background: #ef4444; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 600; cursor: pointer; font-family: var(--font-body); font-size: 0.85rem; transition: all 0.2s ease; }
    .btn-danger:hover { background: #dc2626; }
    .btn-logout { background: none; border: 1px solid var(--border); color: var(--text-medium); padding: 0.35rem 0.75rem; border-radius: 4px; font-size: 0.8rem; font-weight: 600; cursor: pointer; font-family: var(--font-body); transition: all 0.2s ease; margin-left: 1rem; }
    .btn-logout:hover { border-color: #ef4444; color: #ef4444; background: rgba(239, 68, 68, 0.05); }
    .delete-btn { background: none; border: none; color: var(--text-light); cursor: pointer; font-size: 1.1rem; padding: 0.25rem 0.5rem; border-radius: 4px; transition: all 0.2s ease; line-height: 1; }
    .delete-btn:hover { color: #ef4444; background: rgba(239, 68, 68, 0.1); }

    @media (max-width: 968px) {
      .trips-layout { grid-template-columns: 1fr; }
      .trips-sidebar { border-right: none; border-bottom: 1px solid var(--border); padding-right: 0; padding-bottom: 1.5rem; }
      .countdown-calendar-section { grid-template-columns: 1fr; }
      #worldMap { height: 350px; }
      .calendar-day { min-height: 90px; }
    }
    @media (max-width: 768px) {
      .logo-image { height: 160px; }
      .page-title { font-size: 1.75rem; }
      .quick-nav { grid-template-columns: repeat(3, 1fr); }
      .form-row { grid-template-columns: 1fr; }
      .countdown-value { font-size: 2.5rem; }
      .calendar-day { min-height: 70px; font-size: 0.7rem; }
      .calendar-event { font-size: 0.65rem; padding: 0.25rem 0.35rem; }
    }

    /* Photo with actual images */
    .photo-card { position: relative; }
    .photo-card img { width: 100%; aspect-ratio: 1; object-fit: cover; display: block; }
    .photo-delete { position: absolute; top: 0.5rem; right: 0.5rem; z-index: 2; }
    .home-photo-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 0.75rem; }
    .home-photo-item { aspect-ratio: 1; border-radius: 6px; overflow: hidden; border: 1px solid var(--border); cursor: pointer; transition: all 0.2s ease; }
    .home-photo-item:hover { transform: scale(1.02); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .home-photo-item img { width: 100%; height: 100%; object-fit: cover; }

    /* Photo lightbox */
    .lightbox { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 3000; align-items: center; justify-content: center; padding: 2rem; flex-direction: column; }
    .lightbox.active { display: flex; }
    .lightbox img { max-width: 90%; max-height: 80vh; border-radius: 8px; }
    .lightbox-close { position: absolute; top: 1rem; right: 1.5rem; color: white; font-size: 2rem; cursor: pointer; background: none; border: none; z-index: 3001; }
    .lightbox-caption { color: white; font-size: 1.1rem; font-weight: 600; text-align: center; margin-top: 1rem; }


    /* Trip editing */
    .trip-add-btn { background: var(--bg-light); border: 1px dashed var(--border); border-radius: 6px; padding: 0.75rem; text-align: center; cursor: pointer; color: var(--text-medium); font-weight: 600; transition: all 0.2s ease; margin-top: 1rem; width: 100%; }
    .trip-add-btn:hover { border-color: var(--primary); color: var(--primary); background: rgba(37, 99, 235, 0.05); }
    .trip-note-item { background: var(--bg-light); padding: 1rem; border-radius: 6px; border-left: 3px solid var(--primary); margin-bottom: 0.75rem; position: relative; }

    /* Photo preview in upload */
    .photo-preview-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 0.5rem; margin-top: 0.75rem; }
    .photo-preview-item { aspect-ratio: 1; border-radius: 4px; overflow: hidden; border: 1px solid var(--border); }
    .photo-preview-item img { width: 100%; height: 100%; object-fit: cover; }

    /* PWA install banner */
    .pwa-banner { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 1rem 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; display: none; align-items: center; gap: 1rem; }
    .pwa-banner.show { display: flex; }
    .pwa-banner-text { flex: 1; font-weight: 600; }
    .pwa-banner-btn { background: white; color: var(--primary); border: none; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 600; cursor: pointer; white-space: nowrap; }
    .pwa-banner-close { background: none; border: none; color: white; font-size: 1.25rem; cursor: pointer; opacity: 0.8; }
  </style>
</head>
<body>
  <!-- Login Overlay -->
  <div id="loginOverlay" class="login-overlay">
    <div class="login-card">
      <img class="logo-image" src="logo.png" alt="Family Hub">
      <h2 class="login-title" id="loginTitle">Set Your PIN</h2>
      <p class="login-subtitle" id="loginSubtitle">Choose a 4-digit PIN to secure your Family Hub</p>
      <form id="loginForm" onsubmit="event.preventDefault(); submitPin();">
        <input type="password" id="pinInput" class="pin-input" maxlength="4" pattern="[0-9]{4}" inputmode="numeric" placeholder="----" required autocomplete="off">
        <div class="login-error" id="loginError"></div>
        <button type="submit" class="btn login-btn" id="loginBtn">Enter</button>
      </form>
    </div>
  </div>

  <header class="header">
    <div class="header-content">
      <div class="logo-container">
        <img class="logo-image" onclick="navigateTo('home')" src="logo.png" alt="Family Hub">
      </div>
      <button class="btn-logout" onclick="logout()">Logout</button>
    </div>
  </header>

  <div class="app-container">
    <!-- HOME PAGE (Same as before) -->
    <div id="page-home" class="page active">
      <div class="page-header">
        <h1 class="page-title">Welcome Home</h1>
        <p class="page-subtitle">Everything that matters, in one place</p>
      </div>

      <!-- PWA Install Banner -->
      <div class="pwa-banner" id="pwaBanner">
        <div class="pwa-banner-text">Add Family Hub to your home screen for easy access</div>
        <button class="pwa-banner-btn" onclick="installPWA()">Install</button>
        <button class="pwa-banner-close" onclick="dismissPWA()">&times;</button>
      </div>

      <div class="quick-nav">
        <div class="quick-nav-item" onclick="navigateTo('calendar')">
          <svg class="quick-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
          <div class="quick-nav-label">Calendar</div>
        </div>
        <div class="quick-nav-item" onclick="navigateTo('photos')">
          <svg class="quick-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
          <div class="quick-nav-label">Photos</div>
        </div>
        <div class="quick-nav-item" onclick="navigateTo('memories')">
          <svg class="quick-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
          <div class="quick-nav-label">Memories</div>
        </div>
        <div class="quick-nav-item" onclick="navigateTo('trips')">
          <svg class="quick-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
          <div class="quick-nav-label">Trips</div>
        </div>
        <div class="quick-nav-item" onclick="navigateTo('timeline')">
          <svg class="quick-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
          <div class="quick-nav-label">Timeline</div>
        </div>
        <div class="quick-nav-item" onclick="navigateTo('tasks')">
          <svg class="quick-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 11 12 14 22 4"></polyline><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg>
          <div class="quick-nav-label">Tasks</div>
        </div>
        <div class="quick-nav-item" onclick="navigateTo('sport')">
          <svg class="quick-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"></path><path d="M2 12h20"></path></svg>
          <div class="quick-nav-label">Sport</div>
        </div>
        <div class="quick-nav-item" onclick="navigateTo('health')">
          <svg class="quick-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"></path></svg>
          <div class="quick-nav-label">Health</div>
        </div>
        <div class="quick-nav-item" onclick="navigateTo('school')">
          <svg class="quick-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>
          <div class="quick-nav-label">School</div>
        </div>
      </div>

      <!-- Countdown + Mini Calendar -->
      <div class="countdown-calendar-section">
        <div id="countdownContainer"></div>

        <div class="mini-calendar-card">
          <div class="mini-calendar-header">
            <h3 class="mini-calendar-title">üìÖ Next 7 Days</h3>
            <button class="mini-calendar-btn" onclick="navigateTo('calendar')">View All ‚Üí</button>
          </div>
          <div id="upcomingEventsHome"></div>
        </div>
      </div>

      <!-- World Map -->
      <div class="map-card">
        <div class="map-header">
          <h3>Our Travel Adventures</h3>
          <p>Past, present, and future destinations</p>
        </div>
        <div id="worldMap"></div>
      </div>

      <!-- Photos -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Recent Family Photos</h2>
          <button class="btn-secondary btn-small" onclick="navigateTo('photos')">View All</button>
        </div>
        <div class="home-photo-grid" id="homePhotoGrid">
          <!-- Populated by renderHomePhotos() -->
        </div>
      </div>
    </div>

    <!-- ENHANCED CALENDAR PAGE -->
    <div id="page-calendar" class="page">
      <div class="page-header">
        <h1 class="page-title">Family Calendar</h1>
        <p class="page-subtitle">Manage events with iPhone sync</p>
      </div>
      
      <!-- iCal Sync Info -->
      <div class="info-box">
        <div class="info-box-title">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
          iPhone Calendar Sync ‚Äî "Family - the boys"
        </div>
        <div class="info-box-text" style="line-height:1.8;">
          <strong>Bring iPhone calendar events into Family Hub:</strong><br>
          1. On iPhone: Open <strong>Calendar</strong> app ‚Üí tap <strong>Calendars</strong> (bottom) ‚Üí tap <strong>‚ìò</strong> next to "Family - the boys" ‚Üí tap <strong>Share Calendar</strong> ‚Üí choose <strong>Export</strong> ‚Üí save the .ics file.<br>
          2. Or on Mac: Open Calendar ‚Üí right-click "Family - the boys" ‚Üí <strong>Export‚Ä¶</strong> ‚Üí save .ics.<br>
          3. Click <strong>"Import iPhone Calendar"</strong> button below and select the .ics file ‚Äî all events will be added here. Re-import at any time to pick up new entries (duplicates are skipped automatically).<br><br>
          <strong>Send Family Hub events to iPhone:</strong> Click <strong>"Export .ics"</strong> ‚Üí open the file on iPhone ‚Üí tap <strong>Add All Events</strong>. Or subscribe via iOS Settings ‚Üí Calendar ‚Üí Accounts ‚Üí Add Account ‚Üí Other ‚Üí Add Subscribed Calendar.
        </div>
      </div>
      
      <div class="card">
        <div class="calendar-controls">
          <h2 class="calendar-month" id="currentMonth">January 2026</h2>
          <div class="calendar-actions">
            <div class="sync-status synced">
              <svg class="sync-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
              Synced with iPhone
            </div>
            <button class="btn-secondary btn-small" onclick="changeMonth(-1)">‚Üê Prev</button>
            <button class="btn-secondary btn-small" onclick="changeMonth(1)">Next ‚Üí</button>
            <button class="btn-secondary btn-small" onclick="importCalendarICS()" title="Import events from iPhone Calendar .ics export">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:inline;margin-right:0.25rem;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
              Import iPhone Calendar
            </button>
            <button class="btn-secondary btn-small" onclick="exportCalendar()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline; margin-right: 0.25rem;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
              Export .ics
            </button>
          </div>
        </div>
        <div class="calendar-grid" id="calendarGrid"></div>
        <button class="btn" style="margin-top: 1.5rem;" onclick="openModal('eventModal')">Add Event</button>
      </div>

      <!-- Upcoming Events List -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Upcoming Events</h2>
        </div>
        <div class="event-list" id="eventList">
          <!-- Events populated by JavaScript -->
        </div>
      </div>
    </div>

    <!-- HEALTH PAGE with Attachments -->
    <div id="page-health" class="page">
      <div class="page-header">
        <h1 class="page-title">Health Records</h1>
        <p class="page-subtitle">Family medical information with attachments</p>
      </div>
      <div class="card">
        <div style="margin-bottom: 2rem;">
          <label class="form-label">Filter by family member</label>
          <select class="form-select" onchange="filterHealth(this.value)">
            <option value="all">All family members</option>
            <option value="evan">Evan</option>
            <option value="finn">Finn</option>
            <option value="darcy">Darcy</option>
          </select>
        </div>
        <div class="health-grid" id="healthGrid">
          <div class="health-record" data-person="finn">
            <div class="health-header">
              <span class="health-name">Finn</span>
              <span class="health-date">15/01/2026</span>
            </div>
            <div class="health-detail">Annual sports physical - cleared for all activities</div>
            <div class="health-attachments">
              <a href="#" class="event-attachment">
                <svg class="attachment-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path></svg>
                Physical Report.pdf
              </a>
              <a href="#" class="event-attachment">
                <svg class="attachment-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path></svg>
                Clearance Form.pdf
              </a>
            </div>
          </div>
          <div class="health-record" data-person="darcy">
            <div class="health-header">
              <span class="health-name">Darcy</span>
              <span class="health-date">08/01/2026</span>
            </div>
            <div class="health-detail">Eye test - new prescription, glasses ordered</div>
            <div class="health-attachments">
              <a href="#" class="event-attachment">
                <svg class="attachment-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path></svg>
                Prescription.pdf
              </a>
              <a href="#" class="event-attachment">
                <svg class="attachment-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path></svg>
                Vision Test Results
              </a>
            </div>
          </div>
          <div class="health-record" data-person="evan">
            <div class="health-header">
              <span class="health-name">Evan</span>
              <span class="health-date">20/12/2025</span>
            </div>
            <div class="health-detail">Annual checkup - all clear, continue current fitness routine</div>
            <div class="health-attachments">
              <a href="#" class="event-attachment">
                <svg class="attachment-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path></svg>
                Blood Work Results.pdf
              </a>
            </div>
          </div>
        </div>
        <button class="btn" onclick="openModal('healthModal')" style="margin-top: 1.5rem;">Add Health Record</button>
      </div>
    </div>

    <!-- EVENT MODAL -->
    <div id="eventModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Add Event</h3>
          <button class="close-modal" onclick="closeModal('eventModal')">√ó</button>
        </div>
        <form onsubmit="addEvent(event)">
          <div class="form-group">
            <label class="form-label">Event Title</label>
            <input type="text" class="form-input" placeholder="e.g. Finn's Soccer Match" required>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Date</label>
              <input type="date" class="form-input" required>
            </div>
            <div class="form-group">
              <label class="form-label">Time</label>
              <input type="time" class="form-input">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Location</label>
            <input type="text" class="form-input" placeholder="e.g. Glenorchy Soccer Fields">
          </div>
          
          <div class="form-checkbox-group">
            <input type="checkbox" id="recurringEvent" class="form-checkbox">
            <label for="recurringEvent" class="form-label" style="margin: 0;">üîÅ Recurring Event</label>
          </div>
          
          <div class="form-group" id="recurringOptions" style="display: none;">
            <label class="form-label">Repeat Frequency</label>
            <select class="form-select">
              <option value="daily">Daily</option>
              <option value="weekly">Weekly</option>
              <option value="biweekly">Bi-weekly</option>
              <option value="monthly">Monthly</option>
              <option value="yearly">Yearly</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">Category</label>
            <select class="form-select">
              <option value="family">üë®‚Äçüë©‚Äçüë¶ Family</option>
              <option value="sport">‚öΩ Sport</option>
              <option value="school">üìö School</option>
              <option value="health">üíä Health</option>
              <option value="travel">‚úàÔ∏è Travel</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">Notes</label>
            <textarea class="form-textarea" placeholder="Additional details..."></textarea>
          </div>
          
          <div class="form-group">
            <label class="form-label">Links & Attachments</label>
            <input type="url" class="form-input" placeholder="https://example.com" style="margin-bottom: 0.5rem;">
            <input type="file" class="form-input" multiple style="padding: 0.5rem;">
            <p style="font-size: 0.85rem; color: var(--text-medium); margin-top: 0.5rem;">Add relevant links or attach documents</p>
          </div>
          
          <button type="submit" class="btn" style="width: 100%;">Save Event</button>
        </form>
      </div>
    </div>

    <!-- HEALTH RECORD MODAL -->
    <div id="healthModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Add Health Record</h3>
          <button class="close-modal" onclick="closeModal('healthModal')">√ó</button>
        </div>
        <form onsubmit="addHealthRecord(event)">
          <div class="form-group">
            <label class="form-label">Family Member</label>
            <select class="form-select" required>
              <option value="">Select person...</option>
              <option value="evan">Evan</option>
              <option value="finn">Finn</option>
              <option value="darcy">Darcy</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Date</label>
            <input type="date" class="form-input" required>
          </div>
          <div class="form-group">
            <label class="form-label">Record Type</label>
            <select class="form-select">
              <option value="checkup">Checkup</option>
              <option value="vaccination">Vaccination</option>
              <option value="test">Test Results</option>
              <option value="prescription">Prescription</option>
              <option value="specialist">Specialist Visit</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Details</label>
            <textarea class="form-textarea" placeholder="Record details..." required></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">Attachments</label>
            <input type="file" class="form-input" multiple style="padding: 0.5rem;">
            <p style="font-size: 0.85rem; color: var(--text-medium); margin-top: 0.5rem;">Attach test results, prescriptions, or related documents</p>
          </div>
          <div class="form-checkbox-group">
            <input type="checkbox" id="healthAddToCalendar" class="form-checkbox">
            <label for="healthAddToCalendar" class="form-label" style="margin: 0;">Add to Family Calendar</label>
          </div>
          <button type="submit" class="btn" style="width: 100%;">Save Health Record</button>
        </form>
      </div>
    </div>

    <!-- PHOTO UPLOAD MODAL -->
    <div id="photoModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Upload Photos</h3>
          <button class="close-modal" onclick="closeModal('photoModal')">√ó</button>
        </div>
        <form onsubmit="addPhoto(event)">
          <div class="form-group">
            <label class="form-label">Select Photos</label>
            <input type="file" class="form-input" id="photoFileInput" accept="image/*" multiple style="padding: 0.5rem;" required onchange="previewPhotos(this)">
            <div class="photo-preview-grid" id="photoPreview"></div>
          </div>
          <div class="form-group">
            <label class="form-label">Date</label>
            <input type="date" class="form-input" id="photoDate" required>
          </div>
          <div class="form-group">
            <label class="form-label">Description (optional)</label>
            <input type="text" class="form-input" id="photoDescription" placeholder="e.g. Family Christmas 2025">
          </div>
          <button type="submit" class="btn" style="width: 100%;">Upload Photos</button>
        </form>
      </div>
    </div>

    <!-- ADD MEMORY MODAL -->
    <div id="memoryModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Add Memory</h3>
          <button class="close-modal" onclick="closeModal('memoryModal')">√ó</button>
        </div>
        <form onsubmit="addMemory(event)">
          <div class="form-group">
            <label class="form-label">Date</label>
            <input type="date" class="form-input" required>
          </div>
          <div class="form-group">
            <label class="form-label">Title</label>
            <input type="text" class="form-input" placeholder="e.g. Family Beach Day" required>
          </div>
          <div class="form-group">
            <label class="form-label">Description</label>
            <textarea class="form-textarea" placeholder="Tell the story of this special moment..." required></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">Photos (optional)</label>
            <input type="file" class="form-input" accept="image/*" multiple style="padding: 0.5rem;">
          </div>
          <button type="submit" class="btn" style="width: 100%;">Save Memory</button>
        </form>
      </div>
    </div>

    <!-- PLAN NEW TRIP MODAL -->
    <div id="tripModal" class="modal">
      <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
          <h3 class="modal-title">Plan New Trip</h3>
          <button class="close-modal" onclick="closeModal('tripModal')">√ó</button>
        </div>
        <form onsubmit="addTrip(event)">
          <div class="form-group">
            <label class="form-label">Trip Name</label>
            <input type="text" class="form-input" id="tripName" placeholder="e.g. Bali Family Holiday" required>
          </div>
          <div class="form-group">
            <label class="form-label">Destination</label>
            <input type="text" class="form-input" id="tripDestination" placeholder="e.g. Bali, Indonesia" required>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Start Date</label>
              <input type="date" class="form-input" id="tripStartDate" required>
            </div>
            <div class="form-group">
              <label class="form-label">End Date</label>
              <input type="date" class="form-input" id="tripEndDate" required>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Budget (optional)</label>
            <input type="number" class="form-input" id="tripBudget" placeholder="e.g. 5000">
          </div>
          <div class="form-group">
            <label class="form-label">Notes (optional)</label>
            <textarea class="form-textarea" id="tripNotes" placeholder="General trip notes..."></textarea>
          </div>
          <div class="form-checkbox-group">
            <input type="checkbox" id="tripAddToCalendar" class="form-checkbox" checked>
            <label for="tripAddToCalendar" class="form-label" style="margin: 0;">Add to Family Calendar</label>
          </div>
          <div class="form-checkbox-group">
            <input type="checkbox" id="tripAddToMap" class="form-checkbox" checked>
            <label for="tripAddToMap" class="form-label" style="margin: 0;">Add to Travel Map</label>
          </div>
          <button type="submit" class="btn" style="width: 100%;">Create Trip</button>
        </form>
      </div>
    </div>

    <!-- ADD SPORT ENTRY MODAL -->
    <div id="sportModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Add Sport Entry</h3>
          <button class="close-modal" onclick="closeModal('sportModal')">√ó</button>
        </div>
        <form onsubmit="addSportEntry(event)">
          <div class="form-group">
            <label class="form-label">Participant</label>
            <select class="form-select" id="sportParticipant" required>
              <option value="">Select participant...</option>
              <option value="finn">Finn</option>
              <option value="darcy">Darcy</option>
              <option value="dad">Dad</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Sport</label>
            <select class="form-select" id="sportSport" required>
              <option value="">Select sport...</option>
              <option value="soccer">Soccer</option>
              <option value="futsal">Futsal</option>
              <option value="basketball">Basketball</option>
              <option value="rowing">Rowing</option>
              <option value="table-tennis">Table Tennis</option>
              <option value="golf">Golf</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Entry Type</label>
            <select class="form-select" id="sportType" onchange="toggleSportFields()" required>
              <option value="">Select type...</option>
              <option value="match">Match</option>
              <option value="training">Training Session</option>
            </select>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Start Date</label>
              <input type="date" class="form-input" id="sportStartDate" required>
            </div>
            <div class="form-group">
              <label class="form-label">End Date (optional)</label>
              <input type="date" class="form-input" id="sportEndDate">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Start Time</label>
              <input type="time" class="form-input" id="sportStartTime" required>
            </div>
            <div class="form-group">
              <label class="form-label">End Time (optional)</label>
              <input type="time" class="form-input" id="sportEndTime">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Title</label>
            <input type="text" class="form-input" id="sportTitle" placeholder="e.g. Glenorchy Knights vs Kingborough">
          </div>
          <div class="form-group" id="matchResult" style="display: none;">
            <label class="form-label">Match Result (optional)</label>
            <input type="text" class="form-input" placeholder="e.g. 3-1 Win">
          </div>
          <div class="form-group">
            <label class="form-label">Location</label>
            <input type="text" class="form-input" id="sportLocation" placeholder="e.g. KGV Oval">
          </div>
          <div class="form-checkbox-group">
            <input type="checkbox" id="sportAddToCalendar" class="form-checkbox" checked>
            <label for="sportAddToCalendar" class="form-label" style="margin: 0;">Add to Family Calendar</label>
          </div>
          <div class="form-group">
            <label class="form-label">Notes</label>
            <textarea class="form-textarea" id="sportNotes" placeholder="Performance notes, highlights..."></textarea>
          </div>
          <button type="submit" class="btn" style="width: 100%;">Save Entry</button>
        </form>
      </div>
    </div>

    <!-- ADD TASK MODAL -->
    <div id="taskModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Add Task</h3>
          <button class="close-modal" onclick="closeModal('taskModal')">√ó</button>
        </div>
        <form onsubmit="addTask(event)">
          <div class="form-group">
            <label class="form-label">Task Category</label>
            <select class="form-select" id="taskCategory" required>
              <option value="">Select category...</option>
              <option value="family">Family</option>
              <option value="school">School</option>
              <option value="sport">Sport</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Task Description</label>
            <input type="text" class="form-input" placeholder="e.g. Buy groceries" required>
          </div>
          <div class="form-group">
            <label class="form-label">Due Date (optional)</label>
            <input type="date" class="form-input">
          </div>
          <button type="submit" class="btn" style="width: 100%;">Add Task</button>
        </form>
      </div>
    </div>

    <!-- PHOTOS PAGE - FULL VERSION -->
    <div id="page-photos" class="page">
      <div class="page-header">
        <h1 class="page-title">Family Photos</h1>
        <p class="page-subtitle">Cherished moments captured</p>
      </div>
      
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Photo Gallery</h2>
          <div style="display: flex; gap: 0.5rem;">
            <select class="form-select" style="width: auto;" onchange="filterPhotos(this.value)">
              <option value="all">All Photos</option>
              <option value="2026">2026</option>
              <option value="2025">2025</option>
            </select>
            <button class="btn btn-small" onclick="openModal('photoModal')">Upload Photos</button>
          </div>
        </div>
        <div class="photo-grid" id="photoGrid">
          <div class="photo-card" data-year="2025">
            <div class="photo-placeholder">üì∑</div>
            <div class="photo-info">Christmas 2025<br><span style="font-size: 0.75rem; opacity: 0.8;">Dec 25</span></div>
          </div>
          <div class="photo-card" data-year="2026">
            <div class="photo-placeholder">üì∑</div>
            <div class="photo-info">Finn's Match Win<br><span style="font-size: 0.75rem; opacity: 0.8;">Jan 18</span></div>
          </div>
          <div class="photo-card" data-year="2025">
            <div class="photo-placeholder">üì∑</div>
            <div class="photo-info">Family Dinner<br><span style="font-size: 0.75rem; opacity: 0.8;">Nov 20</span></div>
          </div>
          <div class="photo-card" data-year="2025">
            <div class="photo-placeholder">üì∑</div>
            <div class="photo-info">Beach Trip<br><span style="font-size: 0.75rem; opacity: 0.8;">Oct 15</span></div>
          </div>
          <div class="photo-card" data-year="2026">
            <div class="photo-placeholder">üì∑</div>
            <div class="photo-info">Birthday Party<br><span style="font-size: 0.75rem; opacity: 0.8;">Jan 5</span></div>
          </div>
          <div class="photo-card" data-year="2025">
            <div class="photo-placeholder">üì∑</div>
            <div class="photo-info">School Event<br><span style="font-size: 0.75rem; opacity: 0.8;">Dec 10</span></div>
          </div>
          <div class="photo-card" data-year="2025">
            <div class="photo-placeholder">üì∑</div>
            <div class="photo-info">Soccer Finals<br><span style="font-size: 0.75rem; opacity: 0.8;">Nov 5</span></div>
          </div>
          <div class="photo-card" data-year="2026">
            <div class="photo-placeholder">üì∑</div>
            <div class="photo-info">New Year 2026<br><span style="font-size: 0.75rem; opacity: 0.8;">Jan 1</span></div>
          </div>
        </div>
      </div>
    </div>

    <!-- MEMORIES PAGE - FULL VERSION -->
    <div id="page-memories" class="page">
      <div class="page-header">
        <h1 class="page-title">Family Memories</h1>
        <p class="page-subtitle">Special moments we treasure</p>
      </div>
      
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Timeline of Memories</h2>
          <button class="btn btn-small" onclick="openModal('memoryModal')">Add Memory</button>
        </div>
        <div class="memory-timeline" id="memoryTimeline">
          <div class="memory-item">
            <div class="memory-date">January 2026</div>
            <div class="memory-content">
              <div class="memory-title">üéâ Website Launch</div>
              <div class="memory-text">Successfully launched our Family Hub website! Now we can keep track of everything in one place. The boys are excited to see photos and track their activities.</div>
            </div>
          </div>
          <div class="memory-item">
            <div class="memory-date">December 2025</div>
            <div class="memory-content">
              <div class="memory-title">üéÑ Family Christmas</div>
              <div class="memory-text">Wonderful Christmas celebration with the whole family. Finn and Darcy loved their gifts, and we enjoyed a beautiful day together. Best Christmas yet!</div>
              <div class="memory-photos">
                <div class="memory-photo">üì∑</div>
                <div class="memory-photo">üì∑</div>
                <div class="memory-photo">üì∑</div>
                <div class="memory-photo">üì∑</div>
              </div>
            </div>
          </div>
          <div class="memory-item">
            <div class="memory-date">November 2025</div>
            <div class="memory-content">
              <div class="memory-title">‚öΩ Finn Selected for State Team</div>
              <div class="memory-text">Incredible news! Finn was selected for the Tasmania State soccer team. So proud of all his hard work and dedication. This is a huge achievement and we celebrated with the whole family.</div>
            </div>
          </div>
          <div class="memory-item">
            <div class="memory-date">October 2025</div>
            <div class="memory-content">
              <div class="memory-title">üéÆ Darcy's Gaming Tournament</div>
              <div class="memory-text">Darcy competed in his first major gaming tournament and placed in the top 10. Great achievement! He was nervous at first but performed brilliantly.</div>
              <div class="memory-photos">
                <div class="memory-photo">üì∑</div>
                <div class="memory-photo">üì∑</div>
              </div>
            </div>
          </div>
          <div class="memory-item">
            <div class="memory-date">September 2025</div>
            <div class="memory-content">
              <div class="memory-title">üèñÔ∏è Weekend at Bruny Island</div>
              <div class="memory-text">Perfect family weekend away at Bruny Island. Explored the lighthouse, tried fresh oysters, and enjoyed quality time together away from the city.</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- TRIPS PAGE - FULL DYNAMIC VERSION -->
    <div id="page-trips" class="page">
      <div class="page-header">
        <h1 class="page-title">Family Trips</h1>
        <p class="page-subtitle">Adventures and getaways</p>
      </div>

      <div class="trips-layout">
        <div class="trips-sidebar">
          <button class="btn" style="width: 100%; margin-bottom: 1rem;" onclick="openModal('tripModal')">Plan New Trip</button>
          <div class="trip-list" id="tripList">
            <!-- Populated by renderTrips() -->
          </div>
        </div>
        <div class="trip-detail" id="tripDetail">
          <div style="text-align: center; padding: 3rem; color: var(--text-medium);">
            <p style="font-size: 1.1rem;">Select a trip to view details</p>
          </div>
        </div>
      </div>
    </div>
    <!-- SPORT PAGE - FULL VERSION -->
    <div id="page-sport" class="page">
      <div class="page-header">
        <h1 class="page-title">Sport Tracking</h1>
        <p class="page-subtitle">Matches, training & activities</p>
      </div>
      
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Recent Matches & Training</h2>
          <button class="btn btn-small" onclick="openModal('sportModal')">Add Entry</button>
        </div>
        <div class="sport-entries" id="sportEntriesList">
          <div class="sport-entry">
            <div class="sport-entry-header">
              <div>
                <div class="sport-entry-title">State Team Training Session</div>
                <div style="color: var(--text-medium); font-size: 0.9rem;">üìÖ Sunday, Jan 26, 2026 ‚Ä¢ 10:00am</div>
              </div>
              <div class="sport-badge">‚öΩ Training</div>
            </div>
            <div style="margin: 1rem 0;">Regular Sunday morning training session with Tasmania State Team at KGV Oval. Focused on passing drills, set pieces, and small-sided games. Coach praised Finn's positioning and teamwork throughout the session.</div>
            <div class="sport-result">
              <div style="font-weight: 600; margin-bottom: 0.5rem;">üìä Performance Notes:</div>
              <div style="color: var(--text-medium);">Excellent effort and attitude. Continuing to improve ball control and spatial awareness. Working well with teammates on combination play.</div>
            </div>
          </div>
          
          <div class="sport-entry">
            <div class="sport-entry-header">
              <div>
                <div class="sport-entry-title">Glenorchy Knights vs Kingborough Lions SC</div>
                <div style="color: var(--text-medium); font-size: 0.9rem;">üìÖ Saturday, Jan 18, 2026 ‚Ä¢ 2:00pm</div>
              </div>
              <div class="sport-badge">üèÜ Match</div>
            </div>
            <div style="margin: 1rem 0;">NPL Tasmania U16 league match at KGV Oval. Finn started as attacking midfielder and played 75 minutes before being substituted. Excellent performance with goal and assist.</div>
            <div class="sport-result">
              <div style="font-weight: 600; margin-bottom: 0.75rem;">üéØ Result:</div>
              <div style="background: var(--bg-light); padding: 1rem; border-radius: 6px; display: grid; gap: 0.5rem;">
                <div style="color: var(--primary); font-weight: 700; font-size: 1.25rem;">Glenorchy Knights 3 - 1 Kingborough Lions</div>
                <div style="display: flex; gap: 2rem; margin-top: 0.5rem;">
                  <div><strong>‚öΩ Goals:</strong> 1</div>
                  <div><strong>üéØ Assists:</strong> 1</div>
                  <div><strong>‚è±Ô∏è Minutes:</strong> 75</div>
                </div>
              </div>
            </div>
            <div style="margin-top: 1rem;">
              <div style="font-weight: 600; margin-bottom: 0.5rem;">üé¨ Match Highlights:</div>
              <a href="#" style="color: var(--primary); text-decoration: none; font-size: 0.9rem;">üìπ Watch highlights video ‚Üí</a>
            </div>
          </div>
          
          <div class="sport-entry">
            <div class="sport-entry-header">
              <div>
                <div class="sport-entry-title">State Team Training Session</div>
                <div style="color: var(--text-medium); font-size: 0.9rem;">üìÖ Sunday, Jan 12, 2026 ‚Ä¢ 10:00am</div>
              </div>
              <div class="sport-badge">‚öΩ Training</div>
            </div>
            <div style="margin: 1rem 0;">First training session of 2026 with the State Team. Focus on fitness and conditioning after the break. Technical drills working on first touch and passing under pressure.</div>
            <div class="sport-result">
              <div style="font-weight: 600; margin-bottom: 0.5rem;">üìä Performance Notes:</div>
              <div style="color: var(--text-medium);">Good return to training. Fitness levels maintained over break. Ready for upcoming match schedule.</div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Training Schedule -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Training Schedule</h2>
        </div>
        <div style="display: grid; gap: 0.75rem;">
          <div style="background: var(--bg-light); padding: 1rem; border-radius: 6px; border-left: 3px solid var(--primary);">
            <div style="font-weight: 600; margin-bottom: 0.25rem;">Tasmania State Team</div>
            <div style="color: var(--text-medium); font-size: 0.9rem;">Every Sunday ‚Ä¢ 10:00am-12:00pm ‚Ä¢ KGV Oval</div>
          </div>
          <div style="background: var(--bg-light); padding: 1rem; border-radius: 6px; border-left: 3px solid var(--secondary);">
            <div style="font-weight: 600; margin-bottom: 0.25rem;">Glenorchy Knights</div>
            <div style="color: var(--text-medium); font-size: 0.9rem;">Tuesday & Thursday ‚Ä¢ 5:30pm-7:00pm ‚Ä¢ Glenorchy Soccer Club</div>
          </div>
        </div>
      </div>
    </div>

    <!-- TIMELINE PAGE - FULL VERSION -->
    <div id="page-timeline" class="page">
      <div class="page-header">
        <h1 class="page-title">Family Timeline</h1>
        <p class="page-subtitle">Everything happening in our lives</p>
      </div>
      
      <div class="card">
        <div style="margin-bottom: 1.5rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
          <button class="btn-secondary btn-small" onclick="filterTimeline('all')">All</button>
          <button class="btn-secondary btn-small" onclick="filterTimeline('calendar')">üìÖ Calendar</button>
          <button class="btn-secondary btn-small" onclick="filterTimeline('sport')">‚öΩ Sport</button>
          <button class="btn-secondary btn-small" onclick="filterTimeline('memories')">‚ù§Ô∏è Memories</button>
          <button class="btn-secondary btn-small" onclick="filterTimeline('trips')">‚úàÔ∏è Trips</button>
        </div>
        <div class="timeline">
          <div class="timeline-item" data-category="system">
            <div class="timeline-date">Today, Jan 29, 2026</div>
            <div class="timeline-content">
              <div class="timeline-title">üéâ Family Hub Website Launched!</div>
              <div class="timeline-text">Successfully deployed our complete Family Hub website with all features functional. Now we can track photos, memories, trips, sport, tasks, and everything important to our family in one central place.</div>
              <span class="timeline-source">System</span>
            </div>
          </div>
          
          <div class="timeline-item" data-category="sport">
            <div class="timeline-date">Sunday, Jan 26, 2026</div>
            <div class="timeline-content">
              <div class="timeline-title">‚öΩ State Team Training</div>
              <div class="timeline-text">Finn attended Tasmania State Team training session at KGV Oval. Coach praised his positioning and teamwork.</div>
              <span class="timeline-source">Sport</span>
            </div>
          </div>
          
          <div class="timeline-item" data-category="sport">
            <div class="timeline-date">Saturday, Jan 18, 2026</div>
            <div class="timeline-content">
              <div class="timeline-title">üèÜ Match Victory</div>
              <div class="timeline-text">Glenorchy Knights defeated Kingborough Lions 3-1. Finn scored 1 goal and provided 1 assist in an excellent performance!</div>
              <span class="timeline-source">Sport</span>
            </div>
          </div>
          
          <div class="timeline-item" data-category="calendar">
            <div class="timeline-date">Wednesday, Jan 15, 2026</div>
            <div class="timeline-content">
              <div class="timeline-title">üìÖ Family Planning Meeting</div>
              <div class="timeline-text">Reviewed upcoming Japan trip plans and finalized bookings for accommodation and activities.</div>
              <span class="timeline-source">Calendar</span>
            </div>
          </div>
          
          <div class="timeline-item" data-category="memories">
            <div class="timeline-date">Wednesday, Jan 1, 2026</div>
            <div class="timeline-content">
              <div class="timeline-title">üéä New Year 2026</div>
              <div class="timeline-text">Celebrated New Year with family. Started the year with plans for Japan trip and Finn's continued success with State Team.</div>
              <span class="timeline-source">Memories</span>
            </div>
          </div>
          
          <div class="timeline-item" data-category="memories">
            <div class="timeline-date">Thursday, Dec 25, 2025</div>
            <div class="timeline-content">
              <div class="timeline-title">üéÑ Christmas Day</div>
              <div class="timeline-text">Wonderful family Christmas celebration. Finn and Darcy loved their presents and we enjoyed a beautiful day together.</div>
              <span class="timeline-source">Memories</span>
            </div>
          </div>
          
          <div class="timeline-item" data-category="sport">
            <div class="timeline-date">Sunday, Nov 17, 2025</div>
            <div class="timeline-content">
              <div class="timeline-title">‚öΩ State Team Selection</div>
              <div class="timeline-text">Finn selected for Tasmania State Soccer Team! Incredible achievement recognizing his hard work and dedication.</div>
              <span class="timeline-source">Sport</span>
            </div>
          </div>
          
          <div class="timeline-item" data-category="trips">
            <div class="timeline-date">Saturday, Nov 8, 2025</div>
            <div class="timeline-content">
              <div class="timeline-title">‚úàÔ∏è Sydney Weekend Trip</div>
              <div class="timeline-text">Family weekend in Sydney visiting Darling Harbour, Luna Park and Sydney Opera House.</div>
              <span class="timeline-source">Trips</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- TASKS PAGE - FULL VERSION -->
    <div id="page-tasks" class="page">
      <div class="page-header">
        <h1 class="page-title">Family Tasks</h1>
        <p class="page-subtitle">Stay organized together</p>
      </div>
      
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Task Manager</h2>
          <button class="btn btn-small" onclick="openModal('taskModal')">Add Task</button>
        </div>
        <div class="task-tabs">
          <button class="task-tab active" onclick="showTaskTab('family')">Family</button>
          <button class="task-tab" onclick="showTaskTab('school')">School</button>
          <button class="task-tab" onclick="showTaskTab('sport')">Sport</button>
        </div>
        
        <!-- Family Tasks -->
        <div id="task-family" class="task-content active">
          <div class="task-list" id="taskList-family">
            <div class="task-item" onclick="toggleTask(this)">
              <div class="task-checkbox"></div>
              <div class="task-text">Finalize Japan accommodation bookings</div>
            </div>
            <div class="task-item" onclick="toggleTask(this)">
              <div class="task-checkbox"></div>
              <div class="task-text">Book Mt Fuji day tour</div>
            </div>
            <div class="task-item" onclick="toggleTask(this)">
              <div class="task-checkbox"></div>
              <div class="task-text">Organize family photos from December</div>
            </div>
            <div class="task-item" onclick="toggleTask(this)">
              <div class="task-checkbox"></div>
              <div class="task-text">Sort old clothes for donation</div>
            </div>
            <div class="task-item completed" onclick="toggleTask(this)">
              <div class="task-checkbox">‚úì</div>
              <div class="task-text">Plan weekly meal prep</div>
            </div>
            <div class="task-item completed" onclick="toggleTask(this)">
              <div class="task-checkbox">‚úì</div>
              <div class="task-text">Book Disney tickets for Japan</div>
            </div>
          </div>
        </div>
        
        <!-- School Tasks -->
        <div id="task-school" class="task-content">
          <div class="task-list" id="taskList-school">
            <div class="task-item" onclick="toggleTask(this)">
              <div class="task-checkbox"></div>
              <div class="task-text">Buy school supplies for Term 1</div>
            </div>
            <div class="task-item" onclick="toggleTask(this)">
              <div class="task-checkbox"></div>
              <div class="task-text">Complete uniform name tags</div>
            </div>
            <div class="task-item" onclick="toggleTask(this)">
              <div class="task-checkbox"></div>
              <div class="task-text">Sign Term 1 permission forms</div>
            </div>
            <div class="task-item completed" onclick="toggleTask(this)">
              <div class="task-checkbox">‚úì</div>
              <div class="task-text">Register for parent-teacher meetings</div>
            </div>
            <div class="task-item completed" onclick="toggleTask(this)">
              <div class="task-checkbox">‚úì</div>
              <div class="task-text">Pay school fees for 2026</div>
            </div>
          </div>
        </div>
        
        <!-- Sport Tasks -->
        <div id="task-sport" class="task-content">
          <div class="task-list" id="taskList-sport">
            <div class="task-item" onclick="toggleTask(this)">
              <div class="task-checkbox"></div>
              <div class="task-text">Wash Finn's soccer kits</div>
            </div>
            <div class="task-item" onclick="toggleTask(this)">
              <div class="task-checkbox"></div>
              <div class="task-text">Register for upcoming tournament</div>
            </div>
            <div class="task-item" onclick="toggleTask(this)">
              <div class="task-checkbox"></div>
              <div class="task-text">Buy new soccer boots (size 10)</div>
            </div>
            <div class="task-item" onclick="toggleTask(this)">
              <div class="task-checkbox"></div>
              <div class="task-text">Organize carpool for away match</div>
            </div>
            <div class="task-item completed" onclick="toggleTask(this)">
              <div class="task-checkbox">‚úì</div>
              <div class="task-text">Pay team fees for this term</div>
            </div>
            <div class="task-item completed" onclick="toggleTask(this)">
              <div class="task-checkbox">‚úì</div>
              <div class="task-text">Submit State Team medical forms</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- SCHOOL PAGE - FULL VERSION -->
    <div id="page-school" class="page">
      <div class="page-header">
        <h1 class="page-title">School Resources</h1>
        <p class="page-subtitle">St Virgil's College information and links</p>
      </div>
      
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Important Links</h2>
        </div>
        <div class="link-list">
          <a href="https://www.stvirgils.tas.edu.au" target="_blank" class="link-item">
            <svg class="link-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>
            St Virgil's College Website
          </a>
          <a href="http://pam.stvirgils.tas.edu.au/" target="_blank" class="link-item">
            <svg class="link-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
            Parent Portal (PAM) Login
          </a>
          <a href="https://www.stvirgils.tas.edu.au/news-a-events/calendar" target="_blank" class="link-item">
            <svg class="link-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
            School Calendar 2026
          </a>
          <a href="mailto:jsadmin@stvirgils.tas.edu.au" class="link-item">
            <svg class="link-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
            Contact School Office
          </a>
          <a href="https://www.stvirgils.tas.edu.au/shop/uniform-shop" target="_blank" class="link-item">
            <svg class="link-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><polyline points="17 11 19 13 23 9"></polyline></svg>
            Uniform Shop
          </a>
          <a href="https://www.stvirgils.tas.edu.au/our-college/about/term-dates" target="_blank" class="link-item">
            <svg class="link-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="10" x2="21" y2="10"></line><line x1="3" y1="14" x2="21" y2="14"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
            Term Dates
          </a>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">üìÖ Term Dates 2026</h2>
        </div>
        <div style="display: grid; gap: 1rem;">
          <div style="background: var(--bg-light); padding: 1.25rem; border-radius: 8px; border-left: 4px solid var(--primary);">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 0.25rem;">Term 1</div>
                <div style="color: var(--text-medium);">February 6 - April 16, 2026</div>
              </div>
              <div style="background: var(--primary); color: white; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 600; font-size: 0.85rem;">10 weeks</div>
            </div>
          </div>
          <div style="background: var(--bg-light); padding: 1.25rem; border-radius: 8px; border-left: 4px solid var(--secondary);">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 0.25rem;">Term 2</div>
                <div style="color: var(--text-medium);">May 5 - July 10, 2026</div>
              </div>
              <div style="background: var(--secondary); color: white; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 600; font-size: 0.85rem;">10 weeks</div>
            </div>
          </div>
          <div style="background: var(--bg-light); padding: 1.25rem; border-radius: 8px; border-left: 4px solid var(--accent);">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 0.25rem;">Term 3</div>
                <div style="color: var(--text-medium);">July 28 - October 1, 2026</div>
              </div>
              <div style="background: var(--accent); color: white; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 600; font-size: 0.85rem;">9 weeks</div>
            </div>
          </div>
          <div style="background: var(--bg-light); padding: 1.25rem; border-radius: 8px; border-left: 4px solid #10b981;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 0.25rem;">Term 4</div>
                <div style="color: var(--text-medium);">October 19 - December 11, 2026</div>
              </div>
              <div style="background: #10b981; color: white; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 600; font-size: 0.85rem;">8 weeks</div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">üìû Contact Information</h2>
        </div>
        <div style="display: grid; gap: 1rem;">
          <div style="font-weight: 700; font-size: 1.1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border-light);">Junior School (K-6)</div>
          <div style="display: flex; gap: 1rem; padding: 1rem; background: var(--bg-light); border-radius: 6px;">
            <div style="width: 40px; height: 40px; background: var(--primary); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.25rem; flex-shrink: 0;">üìß</div>
            <div>
              <div style="font-weight: 600; margin-bottom: 0.25rem;">Email</div>
              <div style="color: var(--text-medium);"><a href="mailto:jsadmin@stvirgils.tas.edu.au">jsadmin@stvirgils.tas.edu.au</a></div>
            </div>
          </div>
          <div style="display: flex; gap: 1rem; padding: 1rem; background: var(--bg-light); border-radius: 6px;">
            <div style="width: 40px; height: 40px; background: var(--primary); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.25rem; flex-shrink: 0;">üì±</div>
            <div>
              <div style="font-weight: 600; margin-bottom: 0.25rem;">Phone</div>
              <div style="color: var(--text-medium);"><a href="tel:0362342440">(03) 6234 2440</a></div>
            </div>
          </div>
          <div style="display: flex; gap: 1rem; padding: 1rem; background: var(--bg-light); border-radius: 6px;">
            <div style="width: 40px; height: 40px; background: var(--primary); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.25rem; flex-shrink: 0;">üìç</div>
            <div>
              <div style="font-weight: 600; margin-bottom: 0.25rem;">Address</div>
              <div style="color: var(--text-medium);">102 Patrick Street, Hobart TAS 7000</div>
            </div>
          </div>
          <div style="font-weight: 700; font-size: 1.1rem; padding-top: 0.75rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border-light);">Senior School (7-12)</div>
          <div style="display: flex; gap: 1rem; padding: 1rem; background: var(--bg-light); border-radius: 6px;">
            <div style="width: 40px; height: 40px; background: var(--secondary); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.25rem; flex-shrink: 0;">üìß</div>
            <div>
              <div style="font-weight: 600; margin-bottom: 0.25rem;">Email</div>
              <div style="color: var(--text-medium);"><a href="mailto:adminsvc@stvirgils.tas.edu.au">adminsvc@stvirgils.tas.edu.au</a></div>
            </div>
          </div>
          <div style="display: flex; gap: 1rem; padding: 1rem; background: var(--bg-light); border-radius: 6px;">
            <div style="width: 40px; height: 40px; background: var(--secondary); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.25rem; flex-shrink: 0;">üì±</div>
            <div>
              <div style="font-weight: 600; margin-bottom: 0.25rem;">Phone</div>
              <div style="color: var(--text-medium);"><a href="tel:0362496555">(03) 6249 6555</a></div>
            </div>
          </div>
          <div style="display: flex; gap: 1rem; padding: 1rem; background: var(--bg-light); border-radius: 6px;">
            <div style="width: 40px; height: 40px; background: var(--secondary); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.25rem; flex-shrink: 0;">üìç</div>
            <div>
              <div style="font-weight: 600; margin-bottom: 0.25rem;">Address</div>
              <div style="color: var(--text-medium);">195 Main Road, Austins Ferry TAS 7011</div>
            </div>
          </div>
        </div>
      </div>
    </div>

  <nav class="bottom-nav">
    <div class="nav-container">
      <div class="nav-item active" data-page="home" onclick="navigateTo('home')">
        <svg class="nav-icon" viewBox="0 0 24 24"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path></svg>
        <span>Home</span>
      </div>
      <div class="nav-item" data-page="calendar" onclick="navigateTo('calendar')">
        <svg class="nav-icon" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
        <span>Calendar</span>
      </div>
      <div class="nav-item" data-page="trips" onclick="navigateTo('trips')">
        <svg class="nav-icon" viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
        <span>Trips</span>
      </div>
      <div class="nav-item" data-page="sport" onclick="navigateTo('sport')">
        <svg class="nav-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"></path><path d="M2 12h20"></path></svg>
        <span>Sport</span>
      </div>
      <div class="nav-item" data-page="tasks" onclick="navigateTo('tasks')">
        <svg class="nav-icon" viewBox="0 0 24 24"><polyline points="9 11 12 14 22 4"></polyline><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg>
        <span>Tasks</span>
      </div>
      <div class="nav-item" data-page="health" onclick="navigateTo('health')">
        <svg class="nav-icon" viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2"></path></svg>
        <span>Health</span>
      </div>
    </div>
  </nav>

  <!-- Lightbox for full-size photo viewing -->
  <div id="lightbox" class="lightbox" onclick="closeLightbox()">
    <button class="lightbox-close" onclick="closeLightbox()">&times;</button>
    <img id="lightboxImg" src="" alt="">
    <div class="lightbox-caption" id="lightboxCaption"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script>
    // =====================================================
    // FIREBASE CONFIG
    // =====================================================
    var firebaseConfig = {
      apiKey: "AIzaSyARvw1olWxZYdpwrQV8q5AD9HFlodKcnFc",
      authDomain: "family-hub-bdf29.firebaseapp.com",
      projectId: "family-hub-bdf29",
      storageBucket: "family-hub-bdf29.firebasestorage.app",
      messagingSenderId: "59264949173",
      appId: "1:59264949173:web:45178fb8bb923a5e1917fc"
    };

    var db = null;
    var useFirebase = false;
    try {
      if (typeof firebase !== 'undefined' && firebaseConfig.apiKey && firebaseConfig.apiKey !== 'YOUR_API_KEY') {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        useFirebase = true;
        console.log('Firebase initialized');
      }
    } catch(e) { console.log('Firebase not available, using localStorage only'); }

    // =====================================================
    // NAVIGATION
    // =====================================================
    function navigateTo(pageId) {
      var pages = document.querySelectorAll('.page');
      for (var i = 0; i < pages.length; i++) pages[i].classList.remove('active');
      var target = document.getElementById('page-' + pageId);
      if (target) target.classList.add('active');
      window.scrollTo(0, 0);
      if (pageId === 'trips') { renderTrips(); }
      if (pageId === 'calendar') { renderCalendar(); renderEventList(); }
      if (pageId === 'home') {
        renderUpcomingEvents();
        updateCountdown();
        renderHomePhotos();
        // Leaflet map needs invalidateSize after the container becomes visible again
        setTimeout(function() { if (worldMap) worldMap.invalidateSize(); }, 150);
      }
    }

    function openModal(id) {
      document.getElementById(id).style.display = 'flex';
      if (id === 'photoModal') {
        var dateInput = document.getElementById('photoDate');
        if (dateInput && !dateInput.value) dateInput.value = new Date().toISOString().split('T')[0];
      }
    }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }

    // =====================================================
    // AUTH (PIN-based)
    // =====================================================
    async function hashPin(pin) {
      var enc = new TextEncoder().encode(pin);
      var buf = await crypto.subtle.digest('SHA-256', enc);
      return Array.from(new Uint8Array(buf)).map(function(b){ return b.toString(16).padStart(2,'0'); }).join('');
    }

    function checkAuth() {
      if (sessionStorage.getItem('fh_auth')) {
        document.getElementById('loginOverlay').style.display = 'none';
        return;
      }
      document.getElementById('loginOverlay').style.display = 'flex';
      // Update title based on whether PIN already exists
      var hasPin = localStorage.getItem('fh_pinHash');
      var titleEl = document.getElementById('loginTitle');
      var subtitleEl = document.getElementById('loginSubtitle');
      if (hasPin) {
        if (titleEl) titleEl.textContent = 'Enter Your PIN';
        if (subtitleEl) subtitleEl.textContent = 'Enter your 4-digit PIN to access Family Hub';
      } else {
        if (titleEl) titleEl.textContent = 'Set Your PIN';
        if (subtitleEl) subtitleEl.textContent = 'Choose a 4-digit PIN to secure your Family Hub';
      }
    }

    async function submitPin() {
      var pin = document.getElementById('pinInput').value;
      if (!pin) return;
      var hashed = await hashPin(pin);
      var storedHash = null;

      if (useFirebase) {
        try {
          var doc = await db.collection('familyhub').doc('config').get();
          if (doc.exists) storedHash = doc.data().pinHash;
        } catch(e) {}
      }
      if (!storedHash) storedHash = localStorage.getItem('fh_pinHash');

      if (!storedHash) {
        if (useFirebase) {
          try { await db.collection('familyhub').doc('config').set({ pinHash: hashed }); } catch(e) {}
        }
        localStorage.setItem('fh_pinHash', hashed);
        sessionStorage.setItem('fh_auth', '1');
        document.getElementById('loginOverlay').style.display = 'none';
        alert('PIN set! Use this PIN to log in next time.');
        return;
      }

      if (hashed === storedHash) {
        sessionStorage.setItem('fh_auth', '1');
        document.getElementById('loginOverlay').style.display = 'none';
      } else {
        alert('Incorrect PIN. Please try again.');
        document.getElementById('pinInput').value = '';
      }
    }

    function logout() {
      sessionStorage.removeItem('fh_auth');
      document.getElementById('loginOverlay').style.display = 'flex';
      document.getElementById('pinInput').value = '';
    }

    // =====================================================
    // STORE (localStorage + Firestore dual-write)
    // =====================================================
    var Store = {
      _cache: {},
      _ready: false,
      get: function(key) {
        if (this._cache[key] !== undefined) return this._cache[key];
        try {
          var raw = localStorage.getItem('fh_' + key);
          if (raw) { this._cache[key] = JSON.parse(raw); return this._cache[key]; }
        } catch(e) {}
        return null;
      },
      set: function(key, data) {
        this._cache[key] = data;
        try {
          localStorage.setItem('fh_' + key, JSON.stringify(data));
        } catch(e) {
          if (e.name === 'QuotaExceededError' || e.code === 22 || e.code === 1014) {
            console.warn('localStorage quota exceeded for key: ' + key + '. Data saved to memory/Firestore only.');
            if (key === 'photos') {
              alert('Storage is full. Photos saved to cloud sync only. Consider deleting old photos to free space.');
            }
          }
        }
        if (useFirebase && db) {
          try {
            db.collection('familyhub').doc(key).set({ data: JSON.stringify(data) });
          } catch(e) {}
        }
      },
      getNextId: function(key) {
        var items = this.get(key) || [];
        if (Array.isArray(items)) {
          var maxId = 0;
          for (var i = 0; i < items.length; i++) {
            if (items[i] && items[i].id && items[i].id > maxId) maxId = items[i].id;
          }
          return maxId + 1;
        }
        return 1;
      },
      initListeners: function() {
        if (!useFirebase || !db) return;
        var renderMap = {
          events: function() { renderCalendar(); renderUpcomingEvents(); },
          tasks: function() { renderTasks(); },
          health: function() { renderHealthRecords(); },
          sport_entries: function() { renderSportEntries(); },
          photos: function() { renderPhotos(); renderHomePhotos(); },
          memories: function() { renderMemories(); },
          trips: function() { renderTrips(); initMap(); }
        };
        var keys = Object.keys(renderMap);
        for (var i = 0; i < keys.length; i++) {
          (function(key) {
            db.collection('familyhub').doc(key).onSnapshot(function(doc) {
              if (doc.exists) {
                try {
                  var data = JSON.parse(doc.data().data);
                  Store._cache[key] = data;
                  localStorage.setItem('fh_' + key, JSON.stringify(data));
                  if (Store._ready && renderMap[key]) renderMap[key]();
                } catch(e) {}
              }
            });
          })(keys[i]);
        }
      }
    };

    // =====================================================
    // SEED DEFAULT DATA
    // =====================================================
    function seedDefaultData(callback) {
      var defaultData = {
        events: [
          { id: 1, title: "Japan Trip", date: "2026-10-05", time: "06:00", category: "travel", recurring: false },
          { id: 2, title: "Finn Soccer - Glenorchy Knights", date: "2026-02-08", time: "10:00", category: "sport", recurring: true, recurrenceType: "weekly" },
          { id: 3, title: "Darcy Basketball", date: "2026-02-05", time: "16:00", category: "sport", recurring: true, recurrenceType: "weekly" },
          { id: 4, title: "School Term 1 Starts", date: "2026-02-06", time: "08:30", category: "school", recurring: false },
          { id: 5, title: "Family Dinner", date: "2026-02-07", time: "18:00", category: "family", recurring: true, recurrenceType: "weekly" },
          { id: 6, title: "Dr Wilson - Finn Check-up", date: "2026-02-15", time: "10:00", category: "health", recurring: false }
        ],
        tasks: {
          family: [
            { id: 1, text: "Finalize Japan accommodation bookings", completed: false },
            { id: 2, text: "Book Mt Fuji day tour", completed: false },
            { id: 3, text: "Organize family photos from December", completed: false },
            { id: 4, text: "Sort old clothes for donation", completed: false },
            { id: 5, text: "Plan weekly meal prep", completed: true },
            { id: 6, text: "Book Disney tickets for Japan", completed: true }
          ],
          school: [
            { id: 1, text: "Buy school supplies for Term 1", completed: false },
            { id: 2, text: "Complete uniform name tags", completed: false },
            { id: 3, text: "Sign Term 1 permission forms", completed: false },
            { id: 4, text: "Register for parent-teacher meetings", completed: true },
            { id: 5, text: "Pay school fees for 2026", completed: true }
          ],
          sport: [
            { id: 1, text: "Wash Finn's soccer kits", completed: false },
            { id: 2, text: "Register for upcoming tournament", completed: false },
            { id: 3, text: "Buy new soccer boots (size 10)", completed: false },
            { id: 4, text: "Organize carpool for away match", completed: false },
            { id: 5, text: "Pay team fees for this term", completed: true },
            { id: 6, text: "Submit State Team medical forms", completed: true }
          ]
        },
        health: [
          { id: 1, person: "Finn", type: "check-up", provider: "Dr Sarah Wilson", date: "2026-01-15", notes: "Annual check-up. All good - height 165cm, weight 52kg." },
          { id: 2, person: "Darcy", type: "dentist", provider: "Hobart Dental Care", date: "2026-01-20", notes: "6 month check-up. No cavities." },
          { id: 3, person: "Dad", type: "optometrist", provider: "OPSM Hobart", date: "2025-12-10", notes: "New prescription. Collect glasses next week." }
        ],
        sport_entries: [
          { id: 1, title: "Glenorchy Knights vs Kingborough", date: "2026-01-18", time: "10:00 - 11:30", type: "match", participant: "Finn", sport: "soccer", notes: "Great game, 2 assists", result: "3-1 Win" },
          { id: 2, title: "Futsal Training - Skills Session", date: "2026-01-20", time: "17:00 - 18:00", type: "training", participant: "Finn", sport: "futsal", notes: "Worked on close control and quick passing" },
          { id: 3, title: "Basketball - Clarence Tigers", date: "2026-01-22", time: "16:00 - 17:00", type: "match", participant: "Darcy", sport: "basketball", notes: "First game of the season", result: "45-38 Win" }
        ],
        photos: [
          { id: 1, description: "Christmas 2025", date: "2025-12-25", src: "" },
          { id: 2, description: "Finn's Match Win", date: "2026-01-18", src: "" },
          { id: 3, description: "Family Dinner", date: "2025-11-20", src: "" },
          { id: 4, description: "Beach Trip", date: "2025-10-15", src: "" },
          { id: 5, description: "Birthday Party", date: "2026-01-05", src: "" },
          { id: 6, description: "School Event", date: "2025-12-10", src: "" }
        ],
        memories: [
          { id: 1, date: "January 2026", title: "Website Launch", text: "Successfully launched our Family Hub website! Now we can keep track of everything in one place." },
          { id: 2, date: "December 2025", title: "Christmas Day", text: "Amazing Christmas together. Finn got his new soccer boots and Darcy got his basketball." },
          { id: 3, date: "November 2025", title: "Bruny Island Weekend", text: "Perfect family weekend at Bruny Island. Explored the lighthouse, tried fresh oysters." }
        ],
        trips: [
          {
            id: 1, name: "Japan 2026", destination: "Japan", startDate: "2026-10-05", endDate: "2026-10-17",
            budget: 15000, spent: 8450, status: "upcoming", coords: [35.6762, 139.6503],
            image: "https://images.unsplash.com/photo-1540959733332-eab4deabeeaf?w=800",
            itinerary: [
              { day: 1, title: "Arrival in Tokyo", date: "Monday, Oct 5", activities: [
                { time: "14:00", name: "Land at Narita Airport", desc: "Flight QF79 from Sydney - Booking ref: ABC123" },
                { time: "16:30", name: "Check-in at Hotel", desc: "Shinjuku Prince Hotel - Reservation: DEF456" },
                { time: "19:00", name: "Dinner in Shinjuku", desc: "Explore local restaurants and izakayas" }
              ]},
              { day: 2, title: "Tokyo DisneySea", date: "Tuesday, Oct 6", activities: [
                { time: "08:00", name: "Tokyo DisneySea - Full Day", desc: "Tickets booked - arrive early for rope drop" },
                { time: "21:00", name: "Return to Hotel", desc: "Train from Maihama Station" }
              ]},
              { day: 3, title: "Tokyo Disneyland", date: "Wednesday, Oct 7", activities: [
                { time: "08:00", name: "Tokyo Disneyland - Full Day", desc: "Priority: Space Mountain, Big Thunder Mountain" }
              ]},
              { day: 4, title: "Tokyo Exploration", date: "Thursday, Oct 8", activities: [
                { time: "09:00", name: "Senso-ji Temple", desc: "Historic temple in Asakusa" },
                { time: "13:00", name: "teamLab Borderless", desc: "Digital art museum - tickets pre-booked" },
                { time: "19:00", name: "Shibuya Crossing & Dinner", desc: "Explore Shibuya area" }
              ]},
              { day: 5, title: "Mt Fuji Day Trip", date: "Friday, Oct 9", activities: [
                { time: "07:00", name: "Depart for Mt Fuji", desc: "Bus tour - Lake Kawaguchi and 5th Station" },
                { time: "19:00", name: "Return to Tokyo", desc: "Evening free in Shinjuku" }
              ]},
              { day: 6, title: "Travel to Osaka", date: "Saturday, Oct 10", activities: [
                { time: "10:00", name: "Shinkansen to Osaka", desc: "2.5 hour bullet train - JR Pass" },
                { time: "15:00", name: "Check-in Osaka Hotel", desc: "Hotel in Namba area" },
                { time: "18:00", name: "Dotonbori District", desc: "Neon lights, street food, takoyaki" }
              ]},
              { day: 7, title: "Universal Studios Japan", date: "Sunday, Oct 11", activities: [
                { time: "08:00", name: "USJ - Full Day", desc: "Super Nintendo World, Harry Potter" }
              ]},
              { day: 8, title: "Osaka & Kyoto", date: "Monday, Oct 12", activities: [
                { time: "09:00", name: "Osaka Castle", desc: "Historic castle and grounds" },
                { time: "14:00", name: "Day Trip to Kyoto", desc: "Fushimi Inari, Arashiyama Bamboo Grove" }
              ]}
            ],
            documents: [
              { name: "Flight Tickets - Sydney to Tokyo.pdf", detail: "QF79 - Oct 1, 2026" },
              { name: "Hotel Reservations.pdf", detail: "All hotels confirmed" },
              { name: "Disney & USJ Tickets.pdf", detail: "All park tickets" },
              { name: "Travel Insurance.pdf", detail: "Policy #123456" }
            ],
            budgetItems: [
              { icon: "\u2708\uFE0F", name: "Flights", detail: "Return flights for 3", amount: 4500 },
              { icon: "\ud83c\udfe8", name: "Accommodation", detail: "12 nights total", amount: 2400 },
              { icon: "\ud83c\udfa2", name: "Theme Parks", detail: "Disney, USJ tickets", amount: 1200 },
              { icon: "\ud83c\udf5c", name: "Food Budget", detail: "Estimate: $100/day", amount: 1300 },
              { icon: "\ud83d\ude8c", name: "Transport & Tours", detail: "JR Pass, local transport", amount: 800 }
            ],
            notes: [
              { title: "Wi-Fi & Communication", text: "Pocket Wi-Fi booked - pick up at Narita. Emergency contacts saved." },
              { title: "Packing List", text: "Comfortable walking shoes. Light jacket. Portable phone chargers. Small backpack." },
              { title: "Money & Payments", text: "Cash needed for smaller shops. 7-Eleven ATMs accept foreign cards. IC card for transport." },
              { title: "Food Recommendations", text: "Try: ramen, sushi, tempura, okonomiyaki, takoyaki, matcha desserts." }
            ]
          },
          {
            id: 2, name: "Melbourne Weekend", destination: "Melbourne, Australia", startDate: "2026-03-15", endDate: "2026-03-17",
            budget: 2000, spent: 800, status: "upcoming", coords: [-37.8136, 144.9631],
            itinerary: [
              { day: 1, title: "Arrival & City", date: "Sunday, Mar 15", activities: [
                { time: "10:00", name: "Fly to Melbourne", desc: "Morning flight from Hobart" },
                { time: "14:00", name: "Check-in Hotel", desc: "CBD hotel" },
                { time: "18:00", name: "Dinner at Lygon St", desc: "Italian dinner" }
              ]}
            ],
            documents: [], budgetItems: [
              { icon: "\u2708\uFE0F", name: "Flights", detail: "Return for 3", amount: 600 },
              { icon: "\ud83c\udfe8", name: "Hotel", detail: "2 nights", amount: 400 }
            ], notes: []
          },
          {
            id: 3, name: "Sydney Trip", destination: "Sydney, Australia", startDate: "2025-11-08", endDate: "2025-11-11",
            budget: 3000, spent: 2800, status: "visited", coords: [-33.8688, 151.2093],
            itinerary: [
              { day: 1, title: "Arrival", date: "Saturday, Nov 8", activities: [
                { time: "09:00", name: "Fly to Sydney", desc: "Morning flight" },
                { time: "14:00", name: "Darling Harbour", desc: "Explore waterfront" }
              ]}
            ],
            documents: [], budgetItems: [], notes: []
          }
        ]
      };

      if (useFirebase && db) {
        db.collection('familyhub').doc('events').get().then(function(doc) {
          if (!doc.exists || !doc.data().data) {
            var keys = Object.keys(defaultData);
            for (var i = 0; i < keys.length; i++) {
              Store.set(keys[i], defaultData[keys[i]]);
            }
          }
          if (callback) callback();
        }).catch(function() {
          var keys = Object.keys(defaultData);
          for (var i = 0; i < keys.length; i++) {
            if (!Store.get(keys[i])) Store.set(keys[i], defaultData[keys[i]]);
          }
          if (callback) callback();
        });
      } else {
        var keys = Object.keys(defaultData);
        for (var i = 0; i < keys.length; i++) {
          if (!Store.get(keys[i])) Store.set(keys[i], defaultData[keys[i]]);
        }
        if (callback) callback();
      }
    }

    // =====================================================
    // CALENDAR RENDERING
    // =====================================================
    var currentMonth = new Date().getMonth();
    var currentYear = new Date().getFullYear();
    var miniMonth = new Date().getMonth();
    var miniYear = new Date().getFullYear();

    function renderCalendar() {
      var grid = document.getElementById('calendarGrid');
      if (!grid) return;
      var monthLabel = document.getElementById('currentMonth');
      var monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
      if (monthLabel) monthLabel.textContent = monthNames[currentMonth] + ' ' + currentYear;
      var firstDay = new Date(currentYear, currentMonth, 1).getDay();
      var daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
      var today = new Date();
      var events = Store.get('events') || [];
      var html = '';
      var dayHeaders = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
      for (var d = 0; d < 7; d++) html += '<div class="calendar-day-header">' + dayHeaders[d] + '</div>';
      for (var i = 0; i < firstDay; i++) html += '<div></div>';
      for (var day = 1; day <= daysInMonth; day++) {
        var dateStr = currentYear + '-' + String(currentMonth+1).padStart(2,'0') + '-' + String(day).padStart(2,'0');
        var isToday = (day === today.getDate() && currentMonth === today.getMonth() && currentYear === today.getFullYear());
        var dayEvents = events.filter(function(e) { return e.date === dateStr; });
        var hasEvent = dayEvents.length > 0;
        html += '<div class="calendar-day' + (isToday ? ' today' : '') + (hasEvent ? ' has-event' : '') + '" onclick="openModal(\'eventModal\')">';
        html += '<div class="calendar-day-number">' + day + '</div>';
        html += '<div class="calendar-events">';
        for (var ei = 0; ei < dayEvents.length; ei++) {
          html += '<div class="calendar-event ' + (dayEvents[ei].category || '') + '">' + dayEvents[ei].title + '</div>';
        }
        html += '</div></div>';
      }
      grid.innerHTML = html;
    }

    function prevMonth() { currentMonth--; if (currentMonth < 0) { currentMonth = 11; currentYear--; } renderCalendar(); renderEventList(); }
    function nextMonth() { currentMonth++; if (currentMonth > 11) { currentMonth = 0; currentYear++; } renderCalendar(); renderEventList(); }
    function changeMonth(dir) { if (dir < 0) prevMonth(); else nextMonth(); }

    function exportCalendar() {
      var events = Store.get('events') || [];
      if (events.length === 0) { alert('No events to export'); return; }
      var lines = [
        'BEGIN:VCALENDAR',
        'VERSION:2.0',
        'PRODID:-//Family Hub//EN',
        'CALSCALE:GREGORIAN',
        'METHOD:PUBLISH',
        'X-WR-CALNAME:Family Hub'
      ];
      for (var i = 0; i < events.length; i++) {
        var ev = events[i];
        var dateClean = (ev.date || '').replace(/-/g, '');
        if (!dateClean) continue;
        var uid = 'fh-' + (ev.id || i) + '@family-hub';
        lines.push('BEGIN:VEVENT');
        if (ev.time) {
          var timeParts = ev.time.split(':');
          var timeStr = dateClean + 'T' + (timeParts[0] || '00').padStart(2,'0') + (timeParts[1] || '00').padStart(2,'0') + '00';
          lines.push('DTSTART:' + timeStr);
          // Default 1 hour duration
          var hr = parseInt(timeParts[0] || '0', 10) + 1;
          var endStr = dateClean + 'T' + String(hr).padStart(2,'0') + (timeParts[1] || '00').padStart(2,'0') + '00';
          lines.push('DTEND:' + endStr);
        } else {
          lines.push('DTSTART;VALUE=DATE:' + dateClean);
          lines.push('DTEND;VALUE=DATE:' + dateClean);
        }
        lines.push('SUMMARY:' + (ev.title || 'Event').replace(/[,;\\]/g, ' '));
        if (ev.category) lines.push('CATEGORIES:' + ev.category);
        lines.push('UID:' + uid);
        lines.push('END:VEVENT');
      }
      lines.push('END:VCALENDAR');
      var blob = new Blob([lines.join('\r\n')], { type: 'text/calendar;charset=utf-8' });
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url;
      a.download = 'family-hub-calendar.ics';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function prevMiniMonth() { miniMonth--; if (miniMonth < 0) { miniMonth = 11; miniYear--; } renderMiniCalendar(); }
    function nextMiniMonth() { miniMonth++; if (miniMonth > 11) { miniMonth = 0; miniYear++; } renderMiniCalendar(); }

    // =====================================================
    // ICS IMPORT (iPhone Calendar sync)
    // =====================================================
    function importCalendarICS() {
      var input = document.createElement('input');
      input.type = 'file';
      input.accept = '.ics,text/calendar';
      input.onchange = function(ev) {
        if (!ev.target.files || !ev.target.files.length) return;
        var reader = new FileReader();
        reader.onload = function(e) { parseAndImportICS(e.target.result); };
        reader.onerror = function() { alert('Could not read the file. Please try again.'); };
        reader.readAsText(ev.target.files[0]);
      };
      input.click();
    }

    function icsUnescape(str) {
      return (str || '').replace(/\\n/g, '\n').replace(/\\,/g, ',').replace(/\\;/g, ';').replace(/\\\\/g, '\\').trim();
    }

    function parseICSDateTime(key, value) {
      var v = (value || '').trim();
      var date = '';
      var time = '';
      // Strip trailing Z (UTC) ‚Äî treat as local for simplicity
      if (v.charAt(v.length - 1) === 'Z') v = v.slice(0, -1);
      // VALUE=DATE means date-only (no time component)
      var isDateOnly = key.indexOf('VALUE=DATE') >= 0 && key.indexOf('DATE-TIME') < 0;
      if (isDateOnly || (v.length === 8 && /^\d{8}$/.test(v))) {
        date = v.substring(0,4) + '-' + v.substring(4,6) + '-' + v.substring(6,8);
      } else if (v.indexOf('T') >= 0) {
        var tIdx = v.indexOf('T');
        var dp = v.substring(0, tIdx);
        var tp = v.substring(tIdx + 1);
        date = dp.substring(0,4) + '-' + dp.substring(4,6) + '-' + dp.substring(6,8);
        if (tp.length >= 4) time = tp.substring(0,2) + ':' + tp.substring(2,4);
      } else if (v.length === 8) {
        date = v.substring(0,4) + '-' + v.substring(4,6) + '-' + v.substring(6,8);
      }
      return { date: date, time: time };
    }

    function guessCategoryFromText(text) {
      var t = (text || '').toLowerCase();
      if (/soccer|futsal|football|basketball|rowing|training|match|sport|swim|tennis|gym|cricket|footy/.test(t)) return 'sport';
      if (/school|class|exam|teacher|term|study|homework|assignment|pam|subject/.test(t)) return 'school';
      if (/doctor|dentist|medical|health|physio|hospital|appointment|checkup|gp|dr /.test(t)) return 'health';
      if (/flight|travel|trip|hotel|holiday|departure|arrive|airport/.test(t)) return 'travel';
      return 'family';
    }

    function parseAndImportICS(content) {
      // Normalize line endings, then unfold RFC 5545 folded lines
      var normalized = content.replace(/\r\n/g, '\n').replace(/\r/g, '\n').replace(/\n[ \t]/g, '');
      var lineArr = normalized.split('\n');

      var events = Store.get('events') || [];
      var imported = 0;
      var skipped = 0;
      var inEvent = false;
      var cur = {};

      for (var i = 0; i < lineArr.length; i++) {
        var line = lineArr[i];
        if (line === 'BEGIN:VEVENT') {
          inEvent = true;
          cur = {};
        } else if (line === 'END:VEVENT') {
          if (inEvent && cur.title && cur.date) {
            var isDup = events.some(function(ev) {
              return ev.title === cur.title && ev.date === cur.date;
            });
            if (!isDup) {
              var cat = cur.category || guessCategoryFromText(cur.title + ' ' + (cur.notes || ''));
              events.push({
                id: Store.getNextId('events') + imported,
                title: cur.title,
                date: cur.date,
                time: cur.time || '',
                category: cat,
                notes: cur.notes || '',
                recurring: false,
                importedFromiPhone: true
              });
              imported++;
            } else {
              skipped++;
            }
          }
          inEvent = false;
          cur = {};
        } else if (inEvent) {
          var colonIdx = line.indexOf(':');
          if (colonIdx <= 0) continue;
          var key = line.substring(0, colonIdx).toUpperCase();
          var val = line.substring(colonIdx + 1);
          if (key === 'SUMMARY') {
            cur.title = icsUnescape(val);
          } else if (key.indexOf('DTSTART') === 0) {
            var parsed = parseICSDateTime(key, val);
            cur.date = parsed.date;
            cur.time = parsed.time;
          } else if (key === 'DESCRIPTION') {
            cur.notes = icsUnescape(val);
          } else if (key === 'CATEGORIES') {
            var cats = val.toLowerCase();
            if (/sport|soccer|football|basket/.test(cats)) cur.category = 'sport';
            else if (/school|education/.test(cats)) cur.category = 'school';
            else if (/health|medical|doctor/.test(cats)) cur.category = 'health';
            else if (/travel|trip|holiday/.test(cats)) cur.category = 'travel';
            else cur.category = 'family';
          }
        }
      }

      if (imported > 0) {
        Store.set('events', events);
        renderCalendar();
        renderUpcomingEvents();
        renderEventList();
        var msg = imported + ' event' + (imported !== 1 ? 's' : '') + ' imported from iPhone Calendar!';
        if (skipped > 0) msg += '\n(' + skipped + ' duplicate' + (skipped !== 1 ? 's' : '') + ' skipped)';
        alert(msg);
      } else if (skipped > 0) {
        alert('All ' + skipped + ' event' + (skipped !== 1 ? 's' : '') + ' were already in the calendar (duplicates skipped).');
      } else {
        alert('No events found in the file.\n\nMake sure you are uploading the correct .ics file exported from your iPhone "Family - the boys" calendar.');
      }
    }

    function renderMiniCalendar() {
      var grid = document.getElementById('miniCalendarGrid');
      if (!grid) return;
      var title = document.getElementById('miniCalendarTitle');
      var monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
      if (title) title.textContent = monthNames[miniMonth] + ' ' + miniYear;
      var firstDay = new Date(miniYear, miniMonth, 1).getDay();
      var daysInMonth = new Date(miniYear, miniMonth + 1, 0).getDate();
      var today = new Date();
      var events = Store.get('events') || [];
      var html = '';
      var dayHeaders = ['S','M','T','W','T','F','S'];
      for (var d = 0; d < 7; d++) html += '<div class="mini-calendar-day-header">' + dayHeaders[d] + '</div>';
      for (var i = 0; i < firstDay; i++) html += '<div></div>';
      for (var day = 1; day <= daysInMonth; day++) {
        var dateStr = miniYear + '-' + String(miniMonth+1).padStart(2,'0') + '-' + String(day).padStart(2,'0');
        var isToday = (day === today.getDate() && miniMonth === today.getMonth() && miniYear === today.getFullYear());
        var hasEvent = events.some(function(e) { return e.date === dateStr; });
        html += '<div class="mini-calendar-day' + (isToday ? ' today' : '') + (hasEvent ? ' has-event' : '') + '">' + day + '</div>';
      }
      grid.innerHTML = html;
    }

    function renderUpcomingEvents() {
      var container = document.getElementById('upcomingEventsHome') || document.getElementById('upcomingEvents');
      if (!container) return;
      var events = Store.get('events') || [];
      // Calculate today and 7 days ahead (inclusive), at midnight local time
      var now = new Date();
      now.setHours(0, 0, 0, 0);
      var sevenDaysLater = new Date(now);
      sevenDaysLater.setDate(now.getDate() + 7);
      var todayStr = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0') + '-' + String(now.getDate()).padStart(2,'0');
      var endStr = sevenDaysLater.getFullYear() + '-' + String(sevenDaysLater.getMonth()+1).padStart(2,'0') + '-' + String(sevenDaysLater.getDate()).padStart(2,'0');
      var upcoming = events.filter(function(e) {
        return e.date >= todayStr && e.date <= endStr;
      }).sort(function(a,b) { return a.date.localeCompare(b.date); });
      var dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
      var monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      var html = '';
      for (var i = 0; i < upcoming.length; i++) {
        var e = upcoming[i];
        var d = new Date(e.date + 'T00:00:00');
        var isToday = e.date === todayStr;
        html += '<div class="upcoming-event ' + (e.category || '') + '">';
        html += '<div class="event-date">' + (isToday ? 'Today' : dayNames[d.getDay()]) + ', ' + monthNames[d.getMonth()] + ' ' + d.getDate() + '</div>';
        if (e.time) html += '<div class="event-time">' + e.time + '</div>';
        html += '<div class="event-title">' + e.title + '</div></div>';
      }
      if (upcoming.length === 0) html = '<p style="color: var(--text-medium); padding: 1rem;">No events in the next 7 days</p>';
      container.innerHTML = html;
    }

    function renderEventList() {
      var container = document.getElementById('eventList');
      if (!container) return;
      var events = Store.get('events') || [];
      var monthEvents = events.filter(function(e) {
        var d = new Date(e.date + 'T00:00:00');
        return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
      }).sort(function(a,b) { return a.date.localeCompare(b.date); });
      var html = '';
      for (var i = 0; i < monthEvents.length; i++) {
        var e = monthEvents[i];
        html += '<div class="event-item">';
        html += '<div class="event-item-header"><span class="event-item-title">' + e.title + '</span>';
        html += '<button class="btn-danger btn-small" onclick="deleteEvent(' + e.id + ')">Delete</button></div>';
        html += '<div class="event-item-details">' + e.date + (e.time ? ' at ' + e.time : '') + '</div>';
        html += '<div class="event-item-meta"><span class="event-badge">' + (e.category || 'general') + '</span>';
        if (e.recurring) html += '<span class="event-badge recurring">Recurring</span>';
        html += '</div></div>';
      }
      if (monthEvents.length === 0) html = '<p style="color: var(--text-medium);">No events this month</p>';
      container.innerHTML = html;
    }

    // =====================================================
    // HEALTH RENDERING
    // =====================================================
    var healthFilterValue = 'all';

    function renderHealthRecords() {
      var container = document.getElementById('healthGrid');
      if (!container) return;
      var records = Store.get('health') || [];
      if (healthFilterValue && healthFilterValue !== 'all') {
        records = records.filter(function(r) {
          return r.person && r.person.toLowerCase() === healthFilterValue.toLowerCase();
        });
      }
      var html = '';
      for (var i = 0; i < records.length; i++) {
        var r = records[i];
        var icons = { 'check-up': '\ud83e\ude7a', dentist: '\ud83e\uddb7', optometrist: '\ud83d\udc53', specialist: '\ud83c\udfe5' };
        html += '<div class="health-card"><div class="health-card-header"><div class="health-icon">' + (icons[r.type] || '\ud83c\udfe5') + '</div>';
        html += '<div><div class="health-type">' + r.type + '</div><div class="health-person">' + r.person + '</div></div>';
        html += '<button class="btn-danger btn-small" onclick="deleteHealthRecord(' + r.id + ')">Delete</button></div>';
        html += '<div class="health-details"><div><strong>Provider:</strong> ' + r.provider + '</div>';
        html += '<div><strong>Date:</strong> ' + r.date + '</div>';
        html += '<div><strong>Notes:</strong> ' + r.notes + '</div></div></div>';
      }
      if (records.length === 0) html = '<p style="color: var(--text-medium);">No health records' + (healthFilterValue !== 'all' ? ' for ' + healthFilterValue : ' yet') + '</p>';
      container.innerHTML = html;
    }

    function filterHealth(member) {
      healthFilterValue = member;
      renderHealthRecords();
    }

    // =====================================================
    // SPORT ENTRIES RENDERING
    // =====================================================
    function renderSportEntries() {
      var container = document.getElementById('sportEntriesList');
      if (!container) return;
      var entries = Store.get('sport_entries') || [];
      var sportIcons = { soccer: '\u26bd', futsal: '\u26bd', basketball: '\ud83c\udfc0', rowing: '\ud83d\udea3', 'table-tennis': '\ud83c\udfd3', golf: '\u26f3' };
      var html = '';
      for (var i = 0; i < entries.length; i++) {
        var e = entries[i];
        var icon = sportIcons[e.sport] || '\ud83c\udfc5';
        html += '<div class="sport-entry"><div class="sport-entry-header"><div>';
        html += '<div class="sport-entry-title">' + icon + ' ' + e.title + '</div>';
        html += '<div class="sport-entry-athlete">' + e.participant + '</div></div>';
        html += '<div style="display:flex;gap:0.5rem;align-items:start;"><span class="sport-badge">' + e.type + '</span>';
        html += '<button class="btn-danger btn-small" onclick="deleteSportEntry(' + e.id + ')">Delete</button></div></div>';
        html += '<div class="sport-entry-details"><div class="sport-detail">\ud83d\udcc5 ' + e.date + '</div>';
        html += '<div class="sport-detail">\u23f0 ' + e.time + '</div></div>';
        if (e.result) html += '<div class="sport-result"><div class="sport-result-label">Result</div>' + e.result + '</div>';
        if (e.notes) html += '<div style="margin-top:0.75rem;color:var(--text-medium);">' + e.notes + '</div>';
        html += '</div>';
      }
      if (entries.length === 0) html = '<p style="color: var(--text-medium);">No sport entries yet</p>';
      container.innerHTML = html;
    }

    // =====================================================
    // PHOTO RENDERING (with actual image support)
    // =====================================================
    function renderPhotos() {
      var container = document.getElementById('photoGrid');
      if (!container) return;
      var photos = Store.get('photos') || [];
      var html = '';
      for (var i = 0; i < photos.length; i++) {
        var p = photos[i];
        var d = new Date(p.date + 'T00:00:00');
        var monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        html += '<div class="photo-card" data-year="' + d.getFullYear() + '" style="position:relative;">';
        if (p.src) {
          html += '<img src="' + p.src + '" alt="' + p.description + '" onclick="openLightbox(\'' + p.src.replace(/'/g,"\\'") + '\', \'' + p.description.replace(/'/g,"\\'") + '\')" style="cursor:pointer;">';
        } else {
          html += '<div class="photo-placeholder" style="aspect-ratio:1;display:flex;align-items:center;justify-content:center;background:var(--bg-light);font-size:2rem;">\ud83d\udcf7</div>';
        }
        html += '<div class="photo-info">' + p.description + '<br><span style="font-size:0.75rem;opacity:0.8;">' + monthNames[d.getMonth()] + ' ' + d.getDate() + '</span></div>';
        html += '<button class="delete-btn" onclick="deletePhoto(' + p.id + ')" style="position:absolute;top:0.5rem;right:0.5rem;background:rgba(239,68,68,0.9);color:white;border:none;border-radius:50%;width:24px;height:24px;cursor:pointer;font-size:0.7rem;">X</button>';
        html += '</div>';
      }
      if (photos.length === 0) html = '<p style="color: var(--text-medium); text-align:center; padding:2rem;">No photos yet. Upload some!</p>';
      container.innerHTML = html;
    }

    function renderHomePhotos() {
      var container = document.getElementById('homePhotoGrid');
      if (!container) return;
      var photos = Store.get('photos') || [];
      // Only show photos with actual image data, sorted by most recent date
      var recent = photos.filter(function(p) { return p.src; })
        .sort(function(a, b) { return (b.date || '').localeCompare(a.date || ''); })
        .slice(0, 9);
      var html = '';
      for (var i = 0; i < recent.length; i++) {
        var p = recent[i];
        var safeSrc = p.src.replace(/'/g,"\\'");
        var safeDesc = (p.description || '').replace(/'/g,"\\'");
        html += '<div class="home-photo-item" onclick="openLightbox(\'' + safeSrc + '\', \'' + safeDesc + '\')">';
        html += '<img src="' + p.src + '" alt="' + (p.description || '') + '"></div>';
      }
      if (recent.length === 0) {
        html = '<div style="grid-column:1/-1;text-align:center;padding:2rem;color:var(--text-medium);">' +
          '<div style="font-size:2.5rem;margin-bottom:0.75rem;">üì∑</div>' +
          '<p style="margin-bottom:0.75rem;">No photos yet ‚Äî upload your first family photo!</p>' +
          '<button class="btn btn-small" onclick="openModal(\'photoModal\')">Upload Photos</button>' +
          '</div>';
      }
      container.innerHTML = html;
    }

    function filterPhotos(year) {
      var cards = document.querySelectorAll('.photo-card');
      for (var i = 0; i < cards.length; i++) {
        cards[i].style.display = (year === 'all' || cards[i].dataset.year === year) ? '' : 'none';
      }
    }

    function openLightbox(src, caption) {
      var lb = document.getElementById('lightbox');
      document.getElementById('lightboxImg').src = src;
      document.getElementById('lightboxCaption').textContent = caption || '';
      lb.classList.add('active');
    }
    function closeLightbox() {
      document.getElementById('lightbox').classList.remove('active');
    }

    function previewPhotos(input) {
      var preview = document.getElementById('photoPreview');
      preview.innerHTML = '';
      for (var i = 0; i < input.files.length; i++) {
        var reader = new FileReader();
        reader.onload = function(e) {
          var div = document.createElement('div');
          div.className = 'photo-preview-item';
          div.innerHTML = '<img src="' + e.target.result + '">';
          preview.appendChild(div);
        };
        reader.readAsDataURL(input.files[i]);
      }
    }

    function deletePhoto(id) {
      if (!confirm('Delete this photo?')) return;
      var photos = Store.get('photos') || [];
      photos = photos.filter(function(p) { return p.id !== id; });
      Store.set('photos', photos);
      renderPhotos();
      renderHomePhotos();
    }

    // =====================================================
    // MEMORIES RENDERING
    // =====================================================
    function renderMemories() {
      var container = document.getElementById('memoryTimeline');
      if (!container) return;
      var memories = Store.get('memories') || [];
      var html = '';
      for (var i = 0; i < memories.length; i++) {
        var m = memories[i];
        html += '<div class="memory-item"><div class="memory-date">' + m.date + '</div>';
        html += '<div class="memory-content"><div class="memory-title">' + m.title + '</div>';
        html += '<div class="memory-text">' + m.text + '</div>';
        html += '<button class="btn-danger btn-small" style="margin-top:0.5rem;" onclick="deleteMemory(' + m.id + ')">Delete</button>';
        html += '</div></div>';
      }
      if (memories.length === 0) html = '<p style="color: var(--text-medium);">No memories yet</p>';
      container.innerHTML = html;
    }

    // =====================================================
    // TASKS RENDERING
    // =====================================================
    function renderTasks(category) {
      var categories = category ? [category] : ['family', 'school', 'sport'];
      for (var c = 0; c < categories.length; c++) {
        var cat = categories[c];
        var container = document.getElementById('taskList-' + cat);
        if (!container) continue;
        var allTasks = Store.get('tasks') || { family: [], school: [], sport: [] };
        var tasks = allTasks[cat] || [];
        var html = '';
        for (var i = 0; i < tasks.length; i++) {
          var t = tasks[i];
          html += '<div class="task-item' + (t.completed ? ' completed' : '') + '">';
          html += '<div class="task-checkbox" onclick="toggleTask(' + t.id + ',\'' + cat + '\')">' + (t.completed ? '\u2713' : '') + '</div>';
          html += '<div class="task-text">' + t.text + (t.dueDate ? ' <span style="font-size:0.8rem;color:var(--text-medium);">(Due: ' + t.dueDate + ')</span>' : '') + '</div>';
          html += '<button class="delete-btn" onclick="deleteTask(' + t.id + ',\'' + cat + '\')">\u00d7</button>';
          html += '</div>';
        }
        if (tasks.length === 0) html = '<p style="color: var(--text-medium); padding: 1rem;">No tasks</p>';
        container.innerHTML = html;
      }
    }

    // =====================================================
    // TRIPS RENDERING (Full detail system)
    // =====================================================
    function renderTrips() {
      var container = document.getElementById('tripList');
      if (!container) return;
      var trips = Store.get('trips') || [];
      var monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      var html = '';
      for (var i = 0; i < trips.length; i++) {
        var t = trips[i];
        var s = new Date(t.startDate + 'T00:00:00');
        var e = new Date(t.endDate + 'T00:00:00');
        var days = Math.ceil((e - s) / (1000*60*60*24)) + 1;
        var statusIcon = t.status === 'visited' ? '\u2705 ' : '\ud83d\udcc5 ';
        html += '<div class="trip-item" onclick="showTripDetail(' + t.id + ')" id="trip-item-' + t.id + '">';
        html += '<div class="trip-item-name">' + statusIcon + t.name + '</div>';
        html += '<div class="trip-item-dates">' + monthNames[s.getMonth()] + ' ' + s.getDate() + '-' + e.getDate() + ', ' + s.getFullYear() + ' &bull; ' + days + ' days</div>';
        html += '</div>';
      }
      if (trips.length === 0) html = '<p style="color: var(--text-medium); padding: 1rem;">No trips planned yet</p>';
      container.innerHTML = html;

      // Auto-select first trip
      if (trips.length > 0) {
        var detail = document.getElementById('tripDetail');
        if (detail && detail.innerHTML.indexOf('Select a trip') >= 0) {
          showTripDetail(trips[0].id);
        }
      }
    }

    function showTripDetail(tripId) {
      var trips = Store.get('trips') || [];
      var trip = null;
      for (var i = 0; i < trips.length; i++) { if (trips[i].id === tripId) { trip = trips[i]; break; } }
      if (!trip) return;

      // Highlight sidebar
      var items = document.querySelectorAll('.trip-item');
      for (var i = 0; i < items.length; i++) items[i].classList.remove('active');
      var activeItem = document.getElementById('trip-item-' + tripId);
      if (activeItem) activeItem.classList.add('active');

      var detail = document.getElementById('tripDetail');
      var s = new Date(trip.startDate + 'T00:00:00');
      var e = new Date(trip.endDate + 'T00:00:00');
      var days = Math.ceil((e - s) / (1000*60*60*24)) + 1;
      var monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];

      var html = '<div class="trip-header"><div><h2 class="trip-title">' + trip.name + '</h2>';
      html += '<div style="display:flex;gap:1.5rem;margin-top:0.75rem;color:var(--text-medium);flex-wrap:wrap;">';
      html += '<div>\ud83d\udcc5 ' + monthNames[s.getMonth()] + ' ' + s.getDate() + '-' + e.getDate() + ', ' + s.getFullYear() + '</div>';
      html += '<div>\u23f1 ' + days + ' days</div>';
      if (trip.budget) html += '<div>\ud83d\udcb0 Budget: $' + trip.budget.toLocaleString() + '</div>';
      html += '</div></div>';
      html += '<button class="btn-danger btn-small" onclick="deleteTrip(' + tripId + ')">Delete Trip</button></div>';

      // Tabs
      html += '<div class="trip-tabs">';
      html += '<button class="trip-tab active" onclick="showTripTabContent(\'itinerary\', this)">Itinerary</button>';
      html += '<button class="trip-tab" onclick="showTripTabContent(\'documents\', this)">Documents</button>';
      html += '<button class="trip-tab" onclick="showTripTabContent(\'budget\', this)">Budget</button>';
      html += '<button class="trip-tab" onclick="showTripTabContent(\'notes\', this)">Notes</button>';
      html += '</div>';

      // ITINERARY TAB
      html += '<div class="trip-tab-content active" id="tc-itinerary">';
      var itinerary = trip.itinerary || [];
      for (var d = 0; d < itinerary.length; d++) {
        var day = itinerary[d];
        html += '<div class="itinerary-day"><div class="itinerary-day-header">';
        html += '<div class="itinerary-day-title">Day ' + day.day + ' - ' + day.title + '</div>';
        html += '<div style="color:var(--text-medium);">' + day.date + '</div></div>';
        html += '<div class="itinerary-activities">';
        var acts = day.activities || [];
        for (var a = 0; a < acts.length; a++) {
          html += '<div class="activity-item"><div class="activity-time">' + acts[a].time + '</div>';
          html += '<div><div class="activity-name">' + acts[a].name + '</div>';
          html += '<div class="activity-description">' + acts[a].desc + '</div></div></div>';
        }
        html += '</div></div>';
      }
      html += '<button class="trip-add-btn" onclick="addTripItineraryDay(' + tripId + ')">+ Add Day</button>';
      html += '</div>';

      // DOCUMENTS TAB
      html += '<div class="trip-tab-content" id="tc-documents">';
      var docs = trip.documents || [];
      html += '<div style="display:grid;gap:1rem;">';
      for (var di = 0; di < docs.length; di++) {
        html += '<div class="trip-doc-item"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>';
        html += '<div style="flex:1;"><div style="font-weight:600;">' + docs[di].name + '</div>';
        html += '<div style="font-size:0.85rem;color:var(--text-medium);">' + docs[di].detail + '</div></div></div>';
      }
      html += '</div>';
      html += '<button class="trip-add-btn" onclick="addTripDocument(' + tripId + ')">+ Add Document</button>';
      html += '</div>';

      // BUDGET TAB
      html += '<div class="trip-tab-content" id="tc-budget">';
      if (trip.budget) {
        var spent = trip.spent || 0;
        var remaining = trip.budget - spent;
        html += '<div style="background:white;border:1px solid var(--border);border-radius:8px;padding:1.5rem;margin-bottom:1.5rem;">';
        html += '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:2rem;text-align:center;">';
        html += '<div><div style="font-size:0.85rem;color:var(--text-medium);margin-bottom:0.5rem;">Total Budget</div>';
        html += '<div style="font-size:2rem;font-weight:700;color:var(--primary);">$' + trip.budget.toLocaleString() + '</div></div>';
        html += '<div><div style="font-size:0.85rem;color:var(--text-medium);margin-bottom:0.5rem;">Spent</div>';
        html += '<div style="font-size:2rem;font-weight:700;color:var(--accent);">$' + spent.toLocaleString() + '</div></div>';
        html += '<div><div style="font-size:0.85rem;color:var(--text-medium);margin-bottom:0.5rem;">Remaining</div>';
        html += '<div style="font-size:2rem;font-weight:700;color:var(--secondary);">$' + remaining.toLocaleString() + '</div></div>';
        html += '</div></div>';
      }
      var budgetItems = trip.budgetItems || [];
      html += '<div style="display:grid;gap:0.75rem;">';
      for (var bi = 0; bi < budgetItems.length; bi++) {
        var b = budgetItems[bi];
        html += '<div class="trip-budget-item">';
        html += '<div style="width:40px;height:40px;background:var(--bg-light);border-radius:8px;display:flex;align-items:center;justify-content:center;">' + (b.icon || '\ud83d\udcb0') + '</div>';
        html += '<div><div style="font-weight:600;">' + b.name + '</div>';
        html += '<div style="font-size:0.85rem;color:var(--text-medium);">' + b.detail + '</div></div>';
        html += '<div style="font-weight:700;font-size:1.1rem;">$' + b.amount.toLocaleString() + '</div></div>';
      }
      html += '</div>';
      html += '<button class="trip-add-btn" onclick="addTripBudgetItem(' + tripId + ')">+ Add Budget Item</button>';
      html += '</div>';

      // NOTES TAB
      html += '<div class="trip-tab-content" id="tc-notes">';
      var notes = trip.notes || [];
      for (var ni = 0; ni < notes.length; ni++) {
        html += '<div class="trip-note-item"><div style="font-weight:600;margin-bottom:0.5rem;">' + notes[ni].title + '</div>';
        html += '<div style="color:var(--text-medium);">' + notes[ni].text + '</div></div>';
      }
      html += '<button class="trip-add-btn" onclick="addTripNote(' + tripId + ')">+ Add Note</button>';
      html += '</div>';

      detail.innerHTML = html;
    }

    function showTripTabContent(tabName, btn) {
      var tabs = btn.parentElement.querySelectorAll('.trip-tab');
      for (var i = 0; i < tabs.length; i++) tabs[i].classList.remove('active');
      btn.classList.add('active');
      var contents = btn.parentElement.parentElement.querySelectorAll('.trip-tab-content');
      for (var i = 0; i < contents.length; i++) contents[i].classList.remove('active');
      var target = document.getElementById('tc-' + tabName);
      if (target) target.classList.add('active');
    }

    function addTripItineraryDay(tripId) {
      var title = prompt('Day title (e.g. Beach Day):');
      if (!title) return;
      var trips = Store.get('trips') || [];
      for (var i = 0; i < trips.length; i++) {
        if (trips[i].id === tripId) {
          if (!trips[i].itinerary) trips[i].itinerary = [];
          var dayNum = trips[i].itinerary.length + 1;
          trips[i].itinerary.push({ day: dayNum, title: title, date: 'Day ' + dayNum, activities: [] });
          break;
        }
      }
      Store.set('trips', trips);
      showTripDetail(tripId);
    }

    function addTripNote(tripId) {
      var title = prompt('Note title:');
      if (!title) return;
      var text = prompt('Note content:');
      if (!text) return;
      var trips = Store.get('trips') || [];
      for (var i = 0; i < trips.length; i++) {
        if (trips[i].id === tripId) {
          if (!trips[i].notes) trips[i].notes = [];
          trips[i].notes.push({ title: title, text: text });
          break;
        }
      }
      Store.set('trips', trips);
      showTripDetail(tripId);
    }

    function addTripBudgetItem(tripId) {
      var name = prompt('Item name (e.g. Flights):');
      if (!name) return;
      var detail = prompt('Details:');
      var amount = parseFloat(prompt('Amount ($):'));
      if (isNaN(amount)) return;
      var trips = Store.get('trips') || [];
      for (var i = 0; i < trips.length; i++) {
        if (trips[i].id === tripId) {
          if (!trips[i].budgetItems) trips[i].budgetItems = [];
          trips[i].budgetItems.push({ icon: '\ud83d\udcb0', name: name, detail: detail || '', amount: amount });
          trips[i].spent = (trips[i].spent || 0) + amount;
          break;
        }
      }
      Store.set('trips', trips);
      showTripDetail(tripId);
    }

    function addTripDocument(tripId) {
      var name = prompt('Document name:');
      if (!name) return;
      var detail = prompt('Details:');
      var trips = Store.get('trips') || [];
      for (var i = 0; i < trips.length; i++) {
        if (trips[i].id === tripId) {
          if (!trips[i].documents) trips[i].documents = [];
          trips[i].documents.push({ name: name, detail: detail || '' });
          break;
        }
      }
      Store.set('trips', trips);
      showTripDetail(tripId);
    }

    function deleteTrip(tripId) {
      if (!confirm('Delete this trip?')) return;
      var trips = Store.get('trips') || [];
      trips = trips.filter(function(t) { return t.id !== tripId; });
      Store.set('trips', trips);
      renderTrips();
      initMap();
      document.getElementById('tripDetail').innerHTML = '<div style="text-align:center;padding:3rem;color:var(--text-medium);"><p>Select a trip to view details</p></div>';
    }

    // =====================================================
    // MAP (reads from Store trips)
    // =====================================================
    var worldMap = null;
    function initMap() {
      var mapEl = document.getElementById('worldMap');
      if (!mapEl) return;
      if (worldMap) { worldMap.remove(); worldMap = null; }
      worldMap = L.map('worldMap').setView([-10, 130], 3);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(worldMap);

      var trips = Store.get('trips') || [];
      var bounds = [];
      for (var i = 0; i < trips.length; i++) {
        var t = trips[i];
        if (t.coords && t.coords.length === 2) {
          var color = t.status === 'visited' ? 'green' : 'blue';
          var marker = L.circleMarker(t.coords, { radius: 8, fillColor: color, color: '#fff', weight: 2, fillOpacity: 0.8 }).addTo(worldMap);
          marker.bindPopup('<strong>' + t.name + '</strong><br>' + t.destination + '<br><em>' + t.startDate + '</em>');
          bounds.push(t.coords);
        }
      }
      // Add home marker (Hobart)
      L.circleMarker([-42.8821, 147.3272], { radius: 10, fillColor: '#ef4444', color: '#fff', weight: 2, fillOpacity: 0.9 }).addTo(worldMap).bindPopup('<strong>Home</strong><br>Hobart, Tasmania');
      bounds.push([-42.8821, 147.3272]);

      if (bounds.length > 1) {
        worldMap.fitBounds(bounds, { padding: [30, 30] });
      }

      // Fix Leaflet rendering when container wasn't fully visible at init
      setTimeout(function() { if (worldMap) worldMap.invalidateSize(); }, 200);
      setTimeout(function() { if (worldMap) worldMap.invalidateSize(); }, 800);
    }

    function geocodeDestination(destination, callback) {
      fetch('https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(destination) + '&limit=1')
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (data && data.length > 0) callback([parseFloat(data[0].lat), parseFloat(data[0].lon)]);
          else callback(null);
        })
        .catch(function() { callback(null); });
    }

    // =====================================================
    // FORM HANDLERS (with calendar writes)
    // =====================================================
    function addEvent(e) {
      e.preventDefault();
      var form = e.target;
      var titleEl = form.querySelector('input[type="text"]');
      var dateEl = form.querySelector('input[type="date"]');
      var timeEl = form.querySelector('input[type="time"]');
      var selects = form.querySelectorAll('select');
      // selects[0] = recurrence type, selects[1] = category
      var categoryEl = selects[selects.length - 1];
      var recurringEl = form.querySelector('input[type="checkbox"]');
      var title = titleEl ? titleEl.value : '';
      var date = dateEl ? dateEl.value : '';
      var time = timeEl ? timeEl.value : '';
      var category = categoryEl ? categoryEl.value : 'family';
      var recurring = recurringEl ? recurringEl.checked : false;
      if (!title || !date) { alert('Please enter a title and date.'); return; }
      var events = Store.get('events') || [];
      events.push({ id: Store.getNextId('events'), title: title, date: date, time: time, category: category, recurring: recurring });
      Store.set('events', events);
      renderCalendar(); renderUpcomingEvents(); renderEventList();
      alert('Event added!');
      form.reset(); closeModal('eventModal');
    }

    function addHealthRecord(e) {
      e.preventDefault();
      var form = e.target;
      var selects = form.querySelectorAll('select');
      var inputs = form.querySelectorAll('input');
      var textareas = form.querySelectorAll('textarea');
      var person = selects[0].value;
      var type = selects[1].value;
      var provider = inputs[0].value;
      var date = inputs[1].value;
      var notes = textareas[0].value;
      var addToCal = document.getElementById('healthAddToCalendar');

      var records = Store.get('health') || [];
      records.unshift({ id: Store.getNextId('health'), person: person, type: type, provider: provider, date: date, notes: notes });
      Store.set('health', records);
      renderHealthRecords();

      // Write to calendar if checked
      if (addToCal && addToCal.checked && date) {
        var events = Store.get('events') || [];
        events.push({
          id: Store.getNextId('events'),
          title: '\ud83c\udfe5 ' + person + ' - ' + type + ' (' + provider + ')',
          date: date, time: '', category: 'health', recurring: false
        });
        Store.set('events', events);
        renderCalendar(); renderUpcomingEvents();
      }

      alert('Health record saved!' + (addToCal && addToCal.checked ? ' Added to calendar.' : ''));
      form.reset(); closeModal('healthModal');
    }

    function addPhoto(e) {
      e.preventDefault();
      var fileInput = document.getElementById('photoFileInput');
      var dateInput = document.getElementById('photoDate');
      var date = dateInput.value || new Date().toISOString().split('T')[0];
      var description = document.getElementById('photoDescription').value;
      if (!fileInput.files.length) return;

      var photos = Store.get('photos') || [];
      var processed = 0;
      var failed = 0;
      var total = fileInput.files.length;

      for (var i = 0; i < total; i++) {
        (function(file, idx) {
          resizeImage(file, 800, function(dataUrl) {
            if (dataUrl) {
              var desc = total === 1 ? (description || file.name) : (description ? description + ' (' + (idx+1) + ')' : file.name);
              photos.unshift({ id: Store.getNextId('photos') + idx, description: desc, date: date, src: dataUrl });
            } else {
              failed++;
            }
            processed++;
            if (processed === total) {
              Store.set('photos', photos);
              renderPhotos(); renderHomePhotos();
              if (failed > 0) {
                alert((total - failed) + ' photo(s) uploaded. ' + failed + ' failed to process.');
              } else {
                alert(total + ' photo(s) uploaded!');
              }
              e.target.reset();
              document.getElementById('photoPreview').innerHTML = '';
              closeModal('photoModal');
            }
          });
        })(fileInput.files[i], i);
      }
    }

    function resizeImage(file, maxWidth, callback) {
      var reader = new FileReader();
      reader.onerror = function() {
        console.error('FileReader failed for: ' + file.name);
        callback(null);
      };
      reader.onload = function(ev) {
        var img = new Image();
        img.onerror = function() {
          console.error('Image load failed for: ' + file.name);
          callback(null);
        };
        img.onload = function() {
          try {
            var canvas = document.createElement('canvas');
            var scale = Math.min(1, maxWidth / img.width);
            canvas.width = img.width * scale;
            canvas.height = img.height * scale;
            canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
            callback(canvas.toDataURL('image/jpeg', 0.7));
          } catch(err) {
            console.error('Canvas resize failed: ' + err.message);
            callback(null);
          }
        };
        img.src = ev.target.result;
      };
      reader.readAsDataURL(file);
    }

    function addMemory(e) {
      e.preventDefault();
      var form = e.target;
      var inputs = form.querySelectorAll('input, textarea');
      var title = inputs[0].value;
      var text = inputs[1].value;
      var d = new Date();
      var monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
      var memories = Store.get('memories') || [];
      memories.unshift({ id: Store.getNextId('memories'), date: monthNames[d.getMonth()] + ' ' + d.getFullYear(), title: title, text: text });
      Store.set('memories', memories);
      renderMemories();
      alert('Memory added!');
      form.reset(); closeModal('memoryModal');
    }

    function addTrip(e) {
      e.preventDefault();
      var name = document.getElementById('tripName').value;
      var dest = document.getElementById('tripDestination').value;
      var startDate = document.getElementById('tripStartDate').value;
      var endDate = document.getElementById('tripEndDate').value;
      var budget = parseFloat(document.getElementById('tripBudget').value) || 0;
      var notes = document.getElementById('tripNotes').value;
      var addToCal = document.getElementById('tripAddToCalendar').checked;
      var addToMap = document.getElementById('tripAddToMap').checked;

      var trips = Store.get('trips') || [];
      var newTrip = {
        id: Store.getNextId('trips'),
        name: name, destination: dest, startDate: startDate, endDate: endDate,
        budget: budget, spent: 0, status: 'upcoming', coords: null,
        itinerary: [], documents: [], budgetItems: [], notes: notes ? [{ title: 'Trip Notes', text: notes }] : []
      };

      // Write to calendar
      if (addToCal) {
        var events = Store.get('events') || [];
        events.push({
          id: Store.getNextId('events'),
          title: '\u2708\uFE0F ' + name + ' - Departure',
          date: startDate, time: '', category: 'travel', recurring: false
        });
        events.push({
          id: Store.getNextId('events') + 1,
          title: '\u2708\uFE0F ' + name + ' - Return',
          date: endDate, time: '', category: 'travel', recurring: false
        });
        Store.set('events', events);
        renderCalendar(); renderUpcomingEvents();
      }

      // Geocode and add to map
      if (addToMap) {
        geocodeDestination(dest, function(coords) {
          if (coords) newTrip.coords = coords;
          trips.push(newTrip);
          Store.set('trips', trips);
          renderTrips(); initMap();
        });
      } else {
        trips.push(newTrip);
        Store.set('trips', trips);
        renderTrips();
      }

      alert('Trip created!' + (addToCal ? ' Added to calendar.' : ''));
      e.target.reset(); closeModal('tripModal');
    }

    function addSportEntry(e) {
      e.preventDefault();
      var participant = document.getElementById('sportParticipant');
      var sport = document.getElementById('sportSport');
      var entryType = document.getElementById('sportType');
      var startDate = document.getElementById('sportStartDate');
      var startTime = document.getElementById('sportStartTime');
      var endDate = document.getElementById('sportEndDate');
      var endTime = document.getElementById('sportEndTime');
      var title = document.getElementById('sportTitle');
      var location = document.getElementById('sportLocation');
      var addToCal = document.getElementById('sportAddToCalendar');
      var notes = document.getElementById('sportNotes');
      var matchResultEl = document.querySelector('#matchResult input');

      var sportIcons = { soccer: '\u26bd', futsal: '\u26bd', basketball: '\ud83c\udfc0', rowing: '\ud83d\udea3', 'table-tennis': '\ud83c\udfd3', golf: '\u26f3' };
      var sportIcon = sportIcons[sport.value] || '\ud83c\udfc5';
      var participantName = participant.options[participant.selectedIndex].text;
      var sportName = sport.options[sport.selectedIndex].text;
      var entryTitle = title.value || (participantName + ' - ' + sportName + ' ' + entryType.options[entryType.selectedIndex].text);
      var timeRange = startTime.value + (endTime.value ? ' - ' + endTime.value : '');

      var entries = Store.get('sport_entries') || [];
      entries.unshift({
        id: Store.getNextId('sport_entries'),
        title: entryTitle, date: startDate.value, time: timeRange, type: entryType.value,
        participant: participantName, sport: sport.value,
        notes: notes.value || '', result: matchResultEl ? matchResultEl.value : ''
      });
      Store.set('sport_entries', entries);
      renderSportEntries();

      if (addToCal && addToCal.checked) {
        var events = Store.get('events') || [];
        events.push({
          id: Store.getNextId('events'),
          title: sportIcon + ' ' + entryTitle,
          date: startDate.value, time: timeRange, category: 'sport', recurring: false,
          location: location.value || '', participant: participantName, sport: sportName
        });
        Store.set('events', events);
        renderCalendar(); renderUpcomingEvents();
      }

      alert('Sport entry added!' + (addToCal && addToCal.checked ? ' Also added to calendar.' : ''));
      e.target.reset();
      document.getElementById('sportAddToCalendar').checked = true;
      document.getElementById('matchResult').style.display = 'none';
      closeModal('sportModal');
    }

    function addTask(e) {
      e.preventDefault();
      var form = e.target;
      var category = document.getElementById('taskCategory').value;
      var text = form.querySelectorAll('input[type="text"]')[0].value;
      var dueDateInput = form.querySelectorAll('input[type="date"]')[0];
      var dueDate = dueDateInput ? dueDateInput.value : '';

      var allTasks = Store.get('tasks') || { family: [], school: [], sport: [] };
      if (!allTasks[category]) allTasks[category] = [];
      var maxId = 0;
      for (var i = 0; i < allTasks[category].length; i++) {
        if (allTasks[category][i].id > maxId) maxId = allTasks[category][i].id;
      }
      allTasks[category].unshift({ id: maxId + 1, text: text, completed: false, dueDate: dueDate });
      Store.set('tasks', allTasks);
      renderTasks(category);

      // Write to calendar if due date set
      if (dueDate) {
        var events = Store.get('events') || [];
        events.push({
          id: Store.getNextId('events'),
          title: '\u2705 Task: ' + text,
          date: dueDate, time: '', category: category, recurring: false
        });
        Store.set('events', events);
        renderCalendar(); renderUpcomingEvents();
      }

      alert('Task added to ' + category + '!' + (dueDate ? ' Added to calendar.' : ''));
      form.reset(); closeModal('taskModal');
    }

    // =====================================================
    // TOGGLE & DELETE HANDLERS
    // =====================================================
    function toggleTask(id, category) {
      var allTasks = Store.get('tasks') || { family: [], school: [], sport: [] };
      var tasks = allTasks[category] || [];
      for (var i = 0; i < tasks.length; i++) {
        if (tasks[i].id === id) { tasks[i].completed = !tasks[i].completed; break; }
      }
      allTasks[category] = tasks;
      Store.set('tasks', allTasks);
      renderTasks(category);
    }

    function deleteEvent(id) {
      if (!confirm('Delete this event?')) return;
      var events = Store.get('events') || [];
      events = events.filter(function(e) { return e.id !== id; });
      Store.set('events', events);
      renderCalendar(); renderUpcomingEvents(); renderEventList();
    }

    function deleteTask(id, category) {
      var allTasks = Store.get('tasks') || { family: [], school: [], sport: [] };
      allTasks[category] = (allTasks[category] || []).filter(function(t) { return t.id !== id; });
      Store.set('tasks', allTasks);
      renderTasks(category);
    }

    function deleteHealthRecord(id) {
      if (!confirm('Delete this health record?')) return;
      var records = Store.get('health') || [];
      records = records.filter(function(r) { return r.id !== id; });
      Store.set('health', records);
      renderHealthRecords();
    }

    function deleteSportEntry(id) {
      if (!confirm('Delete this sport entry?')) return;
      var entries = Store.get('sport_entries') || [];
      entries = entries.filter(function(e) { return e.id !== id; });
      Store.set('sport_entries', entries);
      renderSportEntries();
    }

    function deleteMemory(id) {
      if (!confirm('Delete this memory?')) return;
      var memories = Store.get('memories') || [];
      memories = memories.filter(function(m) { return m.id !== id; });
      Store.set('memories', memories);
      renderMemories();
    }

    // =====================================================
    // UI HELPERS
    // =====================================================
    function toggleSportFields() {
      var sportType = document.getElementById('sportType').value;
      document.getElementById('matchResult').style.display = (sportType === 'match') ? 'block' : 'none';
    }

    function showTaskTab(tabName) {
      var tabs = document.querySelectorAll('.task-tab');
      for (var i = 0; i < tabs.length; i++) tabs[i].classList.remove('active');
      var contents = document.querySelectorAll('.task-content');
      for (var i = 0; i < contents.length; i++) contents[i].classList.remove('active');
      if (event && event.currentTarget) event.currentTarget.classList.add('active');
      document.getElementById('task-' + tabName).classList.add('active');
      renderTasks(tabName);
    }

    function filterTimeline(category) {
      var items = document.querySelectorAll('.timeline-item');
      for (var i = 0; i < items.length; i++) {
        items[i].style.display = (category === 'all' || items[i].dataset.category === category) ? '' : 'none';
      }
    }

    // =====================================================
    // PWA SUPPORT
    // =====================================================
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('sw.js').catch(function(err) { console.log('SW registration failed:', err); });
      });
    }

    var deferredPrompt;
    window.addEventListener('beforeinstallprompt', function(e) {
      e.preventDefault();
      deferredPrompt = e;
      var banner = document.getElementById('pwaBanner');
      if (banner && !localStorage.getItem('fh_pwa_dismissed')) banner.classList.add('show');
    });

    function installPWA() {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then(function() { deferredPrompt = null; });
      }
      var banner = document.getElementById('pwaBanner');
      if (banner) banner.classList.remove('show');
    }
    function dismissPWA() {
      localStorage.setItem('fh_pwa_dismissed', '1');
      var banner = document.getElementById('pwaBanner');
      if (banner) banner.classList.remove('show');
    }

    // =====================================================
    // COUNTDOWN
    // =====================================================
    function getUnsplashUrl(destination) {
      var keywords = {
        'japan': 'photo-1540959733332-eab4deabeeaf',
        'tokyo': 'photo-1540959733332-eab4deabeeaf',
        'melbourne': 'photo-1514395462725-fb4566210144',
        'sydney': 'photo-1506973035872-a4ec16b8e8d9',
        'bali': 'photo-1537996194471-e657df975ab4',
        'london': 'photo-1513635269975-59663e0ac1ad',
        'paris': 'photo-1502602898657-3e91760cbb34',
        'new york': 'photo-1496442226666-8d4d0e62e6e9',
        'hawaii': 'photo-1507876466758-bc54f384809c',
        'fiji': 'photo-1575407293076-0c27d8013580',
        'new zealand': 'photo-1469521669194-babb45599def',
        'queensland': 'photo-1562672835-65dff94e05fe',
        'gold coast': 'photo-1562672835-65dff94e05fe',
        'perth': 'photo-1578662996442-48f60103fc96',
        'tasmania': 'photo-1516117172878-fd2c41f4a759',
        'hobart': 'photo-1516117172878-fd2c41f4a759'
      };
      var dest = (destination || '').toLowerCase();
      for (var key in keywords) {
        if (dest.indexOf(key) >= 0) return 'https://images.unsplash.com/' + keywords[key] + '?w=800';
      }
      return 'https://images.unsplash.com/photo-1488646953014-85cb44e25828?w=800';
    }

    function updateCountdown() {
      var container = document.getElementById('countdownContainer');
      if (!container) return;
      var trips = Store.get('trips') || [];
      var now = new Date();

      // Get upcoming trips sorted by date
      var upcoming = trips.filter(function(t) {
        return new Date(t.startDate + 'T00:00:00') > now;
      }).sort(function(a, b) {
        return new Date(a.startDate + 'T00:00:00') - new Date(b.startDate + 'T00:00:00');
      }).slice(0, 3);

      if (upcoming.length === 0) {
        container.innerHTML = '<div class="countdown-card"><div class="countdown-body"><div class="countdown-title">No upcoming trips</div><div class="countdown-label">Add a trip to see the countdown</div></div></div>';
        return;
      }

      var html = '<div class="countdown-cards">';
      for (var i = 0; i < upcoming.length; i++) {
        var trip = upcoming[i];
        var diff = Math.ceil((new Date(trip.startDate + 'T00:00:00') - now) / (1000*60*60*24));
        var imgUrl = trip.image || getUnsplashUrl(trip.destination || trip.name);
        var isFirst = i === 0;
        html += '<div class="countdown-card" style="cursor:pointer" onclick="navigateTo(\'trips\')">';
        html += '<div class="countdown-image" style="background-image:url(\'' + imgUrl + '\');height:' + (isFirst ? '180' : '100') + 'px;background-size:cover;background-position:center;position:relative">';
        html += '<div class="countdown-overlay">';
        html += '<div class="countdown-destination">' + trip.name + '</div>';
        html += '</div></div>';
        html += '<div class="countdown-body" style="padding:' + (isFirst ? '2rem' : '1rem') + '">';
        html += '<div class="countdown-title">Countdown</div>';
        html += '<div class="countdown-value" style="font-size:' + (isFirst ? '3.5rem' : '2rem') + '">' + diff + '</div>';
        html += '<div class="countdown-label">Days Until Departure</div>';
        html += '</div></div>';
      }
      html += '</div>';
      container.innerHTML = html;
    }

    // =====================================================
    // INITIALIZATION
    // =====================================================
    function renderAll() {
      renderCalendar();
      renderMiniCalendar();
      renderUpcomingEvents();
      renderEventList();
      renderHealthRecords();
      renderSportEntries();
      renderPhotos();
      renderHomePhotos();
      renderMemories();
      renderTasks();
      renderTrips();
      updateCountdown();
      setTimeout(initMap, 500);
    }

    document.addEventListener('DOMContentLoaded', function() {
      var recurringCheckbox = document.getElementById('recurringEvent');
      var recurringOptions = document.getElementById('recurringOptions');
      if (recurringCheckbox) {
        recurringCheckbox.addEventListener('change', function() {
          recurringOptions.style.display = this.checked ? 'block' : 'none';
        });
      }

      checkAuth();

      seedDefaultData(function() {
        Store.initListeners();
        Store._ready = true;
        renderAll();
      });
    });

  </script>
</body>
</html>
